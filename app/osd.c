#include "osd.h"
#include <pthread.h>

#ifndef PTHREAD_MUTEX_RECURSIVE
#define PTHREAD_MUTEX_RECURSIVE PTHREAD_MUTEX_RECURSIVE_NP
#endif


#include <pthread.h> // for pthread_mutex_t
#include <unistd.h>  // for usleep
#include <time.h>    // for time()
#include <errno.h>   // for errno
#include <sys/stat.h> // for file access checking
#include "ss_log.h" // for ss_log_e



// 1. ÂÖ®Â±Ä‰∫íÊñ•ÈîÅ g_mux
static pthread_mutex_t g_mux;
static int g_mux_initialized = 0;

// ÈÄíÂΩíÈîÅÂàùÂßãÂåñÂáΩÊï∞
// ÈÄíÂΩíÈîÅÈîÄÊØÅÂáΩÊï∞Â£∞Êòé
static void cleanup_recursive_mutex(void);

static void init_recursive_mutex(void) {
    if (!g_mux_initialized) {
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
        pthread_mutex_init(&g_mux, &attr);
        pthread_mutexattr_destroy(&attr);
        g_mux_initialized = 1;
        atexit(cleanup_recursive_mutex); // Ê≥®ÂÜåÈÄÄÂá∫Êó∂ÈîÄÊØÅÈîÅ
    }
}

// ÈÄíÂΩíÈîÅÈîÄÊØÅÂáΩÊï∞ÂÆö‰πâ
static void cleanup_recursive_mutex(void) {
    if (g_mux_initialized) {
        pthread_mutex_destroy(&g_mux);
        g_mux_initialized = 0;
    }
}



// ÂáΩÊï∞Â£∞Êòé
void test_single_case(const char *text, int size, TextAlignment align, int spacing, const char *filename);
static int split_text_lines(const char *text, char ***lines, int *line_count);
static int calculate_multiline_size(TTF_Font *font, char **lines, int line_count, 
                                   int *max_width, int *total_height, int line_spacing);
static int render_multiline_text(TTF_Font *font, SDL_Color fg_color, char **lines, 
                                int line_count, SDL_Surface *target_surface,
                                TextAlignment alignment, int line_spacing);
static int render_multiline_text_with_stroke(TTF_Font *font, SDL_Color fg_color, 
                                           char **lines, int line_count, 
                                           SDL_Surface *target_surface,
                                           SDL_Color stroke_color, int stroke_width,
                                           TextAlignment alignment, int line_spacing);

static int ensure_font_style_normal(TTF_Font *font);
static int split_text_lines(const char *text, char ***lines, int *line_count);
static int verify_font_state(TTF_Font *font);




// ÂÉèÁ¥†Ê†ºÂºèËΩ¨Êç¢
int32_t convert_32bit_to_16bit(SDL_Surface *src_surface, SDL_Surface *dest_surface);

// ÊñáÊú¨Ê∏≤ÊüìÂáΩÊï∞
int32_t ttf_get_text(TTF_Font *font, SDL_Color fg, const char *data, ot_bmpp *osd_bmp);
int32_t ttf_get_text_with_stroke(TTF_Font *font, SDL_Color fg_color, 
                                const char *data, ot_bmpp *osd_bmp,
                                SDL_Color stroke_color, int stroke_width);

// BMPÊñá‰ª∂Êìç‰Ωú
int bmp_load_file(const char *filename, ot_bmpp *osd_bmp);
void bmp_free(ot_bmpp *osd_bmp);
int bmp_get_render_params(ot_bmpp *osd_bmp, SDL_Color *text_color, SDL_Color *stroke_color, 
                         int *stroke_width, int *font_size, TextAlignment *alignment, int *line_spacing);
int save_bmp_file(ot_bmpp *osd_bmp, const char *filename);

// BMPÊãºÊé•ÂáΩÊï∞
int bmp_concatenate_vertically(const char **filenames, int count, TextAlignment alignment, const char *output_filename);
int bmp_concatenate_with_rendering(const char **filenames, int count, TextAlignment alignment, 
                                  const char *output_filename, ot_bmpp **out_merged_bmp);

// ÂÖ®Â±ÄËµÑÊ∫êÊ∏ÖÁêÜ
void osd_cleanup(void);




/**
 * @brief Â∞Ü32‰ΩçARGB8888Ë°®Èù¢ËΩ¨Êç¢‰∏∫16‰ΩçARGB1555Ê†ºÂºè
 * @param src_surface 32‰ΩçÊ∫êË°®Èù¢
 * @param dest_surface 16‰ΩçÁõÆÊ†áË°®Èù¢
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int32_t convert_32bit_to_16bit(SDL_Surface *src_surface, SDL_Surface *dest_surface) {
    if (!src_surface || !dest_surface) {
        return TD_FAILURE;
    }
    
    // ÈîÅÂÆöË°®Èù¢ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
    if (SDL_MUSTLOCK(src_surface)) SDL_LockSurface(src_surface);
    if (SDL_MUSTLOCK(dest_surface)) SDL_LockSurface(dest_surface);
    
    Uint32 *src_pixels = (Uint32 *)src_surface->pixels;
    Uint16 *dest_pixels = (Uint16 *)dest_surface->pixels;
    
    int width = src_surface->w;
    int height = src_surface->h;
    
    // ËΩ¨Êç¢ÊØè‰∏™ÂÉèÁ¥†ÔºöARGB8888 -> ARGB1555
    for (int y = 0; y < height; y++) {
        for (int x = 0; x < width; x++) {
            Uint32 pixel32 = src_pixels[y * width + x];
            
            // ÊèêÂèñ32‰ΩçÂÉèÁ¥†ÁöÑÂêÑ‰∏™ÂàÜÈáè
            Uint8 a = (pixel32 >> 24) & 0xFF;  // Alpha (8‰Ωç)
            Uint8 r = (pixel32 >> 16) & 0xFF;  // Red (8‰Ωç)
            Uint8 g = (pixel32 >> 8) & 0xFF;   // Green (8‰Ωç)
            Uint8 b = pixel32 & 0xFF;          // Blue (8‰Ωç)
            
            // ËΩ¨Êç¢‰∏∫16‰ΩçARGB1555Ê†ºÂºè
            Uint16 pixel16 = 0;
            
            // Alpha: 8‰Ωç -> 1‰Ωç (ÈòàÂÄº128)
            if (a > 128) pixel16 |= 0x8000;
            
            // Red: 8‰Ωç -> 5‰Ωç
            pixel16 |= ((r >> 3) << 10) & 0x7C00;
            
            // Green: 8‰Ωç -> 5‰Ωç
            pixel16 |= ((g >> 3) << 5) & 0x03E0;
            
            // Blue: 8‰Ωç -> 5‰Ωç
            pixel16 |= (b >> 3) & 0x001F;
            
            dest_pixels[y * width + x] = pixel16;
        }
    }
    
    // Ëß£ÈîÅË°®Èù¢
    if (SDL_MUSTLOCK(src_surface)) SDL_UnlockSurface(src_surface);
    if (SDL_MUSTLOCK(dest_surface)) SDL_UnlockSurface(dest_surface);
    
    return TD_SUCCESS;
}


/**
 * @brief Â∞Ü UTF-8 ÊñáÊú¨Ê∏≤Êüì‰∏∫‰ΩçÂõæÂπ∂Â≠òÂÇ®Âà∞ ot_bmpp ÁªìÊûÑ‰Ωì‰∏≠ÔºàÂ∏¶ÊäóÈîØÈΩøÔºâ
 * @param font     Â≠ó‰ΩìÂØπË±°ÊåáÈíà
 * @param fg       ÊñáÊú¨È¢úËâ≤ÔºàSDL_Color ÁªìÊûÑ‰ΩìÔºâ
 * @param data     Ë¶ÅÊ∏≤ÊüìÁöÑÊñáÊú¨Â≠óÁ¨¶‰∏≤
 * @param osd_bmp  Â≠òÂÇ®‰ΩçÂõæÊï∞ÊçÆÁöÑÁªìÊûÑ‰ΩìÊåáÈíà
 * @return ÊàêÂäüËøîÂõû TD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõû TD_FAILURE
 */
int32_t ttf_get_text(TTF_Font *font, SDL_Color fg,const char *data, ot_bmpp *osd_bmp) {
    if (TTF_Init() == -1) {
        ss_log_e("TTF_Init failed: %s", TTF_GetError());
        return TD_FAILURE;
    }

    
    // //‰ΩøÁî® TTF_RenderUTF8_SolidÂ∞ÜÊñáÊú¨Ê∏≤ÊüìÊàê SDL_Surface
    // SDL_Surface *text = TTF_RenderUTF8_Solid(font, data, fg);


    //  ‰ΩøÁî®Ê†∑ÂºèÁÆ°ÁêÜÂáΩÊï∞
    if (ensure_font_style_normal(font) != TD_SUCCESS) {
        ss_log_e("Êó†Ê≥ïËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè‰∏∫Ê≠£Â∏∏");
        return TD_FAILURE;
    }

    // È¢ùÂ§ñÈ™åËØÅ
    verify_font_state(font);

    
    // ‰ΩøÁî®ÊäóÈîØÈΩøÊ∏≤ÊüìÂáΩÊï∞ TTF_RenderUTF8_BlendedÔºàÁîüÊàê32‰ΩçË°®Èù¢Ôºâ
    SDL_Surface *text = TTF_RenderUTF8_Blended(font, data, fg);
    if (!text) {
        ss_log_e("TTF_RenderUTF8_Solid failed: %s", TTF_GetError());
        SDL_FreeSurface(text);
        return TD_FAILURE;
    }

    // ÂÆö‰πâ ARGB8888 Ê†ºÂºèÁöÑÊé©Á†Å
    Uint32 rmask32, gmask32, bmask32, amask32;

    rmask32 = 0x00FF0000;  // Á∫¢Ëâ≤Êé©Á†ÅÔºà8‰ΩçÔºâ
    gmask32 = 0x0000FF00;  // ÁªøËâ≤Êé©Á†ÅÔºà8‰ΩçÔºâ
    bmask32 = 0x000000FF;  // ËìùËâ≤Êé©Á†ÅÔºà8‰ΩçÔºâ
    amask32 = 0xFF000000;  // ÈÄèÊòéÂ∫¶Êé©Á†ÅÔºà8‰ΩçÔºâ

    // ÂÆö‰πâ ARGB1555 Ê†ºÂºèÁöÑÊé©Á†Å
    Uint32 rmask16, gmask16, bmask16, amask16;
    rmask16 = 0x7C00;
    gmask16 = 0x03E0;
    bmask16 = 0x001F;
    amask16 = 0x8000;

    //ÂàõÂª∫ÁõÆÊ†áÊ†ºÂºèÁöÑ SDL_Surface (32‰ΩçËâ≤Ê∑±ÔºåARGB8888Ê†ºÂºè)
    SDL_Surface *temp_32bit_surface = SDL_CreateRGBSurface(0, text->w, text->h, 32, 
                                                          rmask32, gmask32, bmask32, amask32);
    if (!temp_32bit_surface) {
        SDL_FreeSurface(text);
        return TD_FAILURE;
    }

    //‰ΩøÁî® SDL_BlitSurfaceÂ∞ÜÊñáÊú¨Ë°®Èù¢Â§çÂà∂Âà∞ÁõÆÊ†áË°®Èù¢
    if (SDL_BlitSurface(text, NULL, temp_32bit_surface, NULL) < 0) {
        ss_log_e("BlitSurface failed: %s", SDL_GetError());
        SDL_FreeSurface(text);
        SDL_FreeSurface(temp_32bit_surface);
        return TD_FAILURE;
    }

    // ÂàõÂª∫16‰ΩçÁõÆÊ†áË°®Èù¢ÔºàÊúÄÁªàËæìÂá∫Ôºâ
    SDL_Surface *target_16bit_surface = SDL_CreateRGBSurface(0, text->w, text->h, 16, 
                                                           rmask16, gmask16, bmask16, amask16);
    if (!target_16bit_surface) {
        SDL_FreeSurface(text);
        SDL_FreeSurface(temp_32bit_surface);
        return TD_FAILURE;
    }

    // Â∞Ü32‰ΩçËΩ¨Êç¢‰∏∫16‰Ωç
    if (convert_32bit_to_16bit(temp_32bit_surface, target_16bit_surface) != TD_SUCCESS) {
        ss_log_e("32‰ΩçÂà∞16‰ΩçËΩ¨Êç¢Â§±Ë¥•");
        SDL_FreeSurface(text);
        SDL_FreeSurface(temp_32bit_surface);
        SDL_FreeSurface(target_16bit_surface);
        return TD_FAILURE;
    }

    //ÂàÜÈÖçÂÜÖÂ≠ò
    //osd_bmp->data = malloc(2 * target_format_surface->w * target_format_surface->h);
    size_t buffer_size = target_16bit_surface->pitch * target_16bit_surface->h;
    osd_bmp->data = malloc(buffer_size);
    if (!osd_bmp->data) {
        SDL_FreeSurface(text);
        SDL_FreeSurface(temp_32bit_surface);
        SDL_FreeSurface(target_16bit_surface);           
        return TD_FAILURE;
    }
    // Â§çÂà∂16‰ΩçÂÉèÁ¥†Êï∞ÊçÆÂà∞ osd_bmp->data
    memcpy(osd_bmp->data, target_16bit_surface->pixels, buffer_size);
    //memcpy(osd_bmp->data, target_format_surface->pixels, 2 * target_format_surface->w * target_format_surface->h);

    // ËÆæÁΩÆ16‰Ωç‰ΩçÂõæÂ±ûÊÄß
    osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
    osd_bmp->width = target_16bit_surface->w;
    osd_bmp->height = target_16bit_surface->h;
    osd_bmp->pitch = target_16bit_surface->pitch;
    
    // üîß ‰ºòÂåñÔºöÂ≠òÂÇ®Ê∏≤ÊüìÂèÇÊï∞ÔºàÂçïË°åÊñáÊú¨ÔºåÊó†ÊèèËæπÔºâ
    osd_bmp->text_color = fg;
    osd_bmp->font_size = TTF_FontHeight(font); // Ëé∑ÂèñÂ≠ó‰ΩìÈ´òÂ∫¶‰Ωú‰∏∫Â≠óÂè∑
    osd_bmp->alignment = ALIGN_LEFT; // ÂçïË°åÊñáÊú¨ÈªòËÆ§Â∑¶ÂØπÈΩê
    osd_bmp->line_spacing = 0; // ÂçïË°åÊñáÊú¨Êó†Ë°åË∑ù
    osd_bmp->stroke_width = 0;
    osd_bmp->has_stroke = 0;
    osd_bmp->stroke_color = (SDL_Color){0, 0, 0, 255}; // ÈªòËÆ§ÈªëËâ≤ÊèèËæπ
    
    // ÂàùÂßãÂåñË∞ÉËâ≤ÊùøÂíåÊèèËæπÊé©Á†Å
    osd_bmp->palette = NULL;
    osd_bmp->palette_size = 0;
    osd_bmp->stroke_mask = NULL;
    
    ss_log_d("ÂçïË°åÊñáÊú¨Ê∏≤ÊüìÂèÇÊï∞Â∑≤Â≠òÂÇ®: È¢úËâ≤(%d,%d,%d,%d), Â≠óÂè∑=%d", 
            osd_bmp->text_color.r, osd_bmp->text_color.g, osd_bmp->text_color.b, osd_bmp->text_color.a,
            osd_bmp->font_size);
    
    //ÈáäÊîæ‰∏¥Êó∂Ë°®Èù¢ËµÑÊ∫ê
    SDL_FreeSurface(text);
    SDL_FreeSurface(temp_32bit_surface);
    SDL_FreeSurface(target_16bit_surface);
    
    TTF_Quit();
    return TD_SUCCESS;
}

/**
 * @brief ‰øùÊåÅÂÖºÂÆπÊÄßÁöÑÂçïË°åÊñáÊú¨Ê∏≤ÊüìÂáΩÊï∞
 */
int ttf_get_bmp(ot_bmpp *osd_bmp, char *osd_buf, SDL_Color color, 
               int32_t fontSize, SDL_Color *stroke_color, int stroke_width) {
    // ÈªòËÆ§‰ΩøÁî®Â±ÖÂ∑¶ÂØπÈΩêÔºåË°åË∑ù‰∏∫0
    return ttf_get_multiline_bmp(osd_bmp, osd_buf, color, fontSize, 
                               stroke_color, stroke_width, ALIGN_LEFT, 0);
}

/**
 * @brief ÁîüÊàêÂ∏¶ÊèèËæπÊïàÊûúÁöÑ16‰Ωç‰ΩçÂõæ
 * @param font Â≠ó‰ΩìÂØπË±°ÊåáÈíà
 * @param fg_color ÊñáÂ≠óÈ¢úËâ≤
 * @param data Ë¶ÅÊ∏≤ÊüìÁöÑÊñáÊú¨Â≠óÁ¨¶‰∏≤
 * @param osd_bmp Â≠òÂÇ®‰ΩçÂõæÊï∞ÊçÆÁöÑÁªìÊûÑ‰ΩìÊåáÈíà
 * @param stroke_color ÊèèËæπÈ¢úËâ≤
 * @param stroke_width ÊèèËæπÂÆΩÂ∫¶ÔºàÂÉèÁ¥†Ôºâ
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int32_t ttf_get_text_with_stroke(TTF_Font *font, SDL_Color fg_color, 
                                const char *data, ot_bmpp *osd_bmp,
                                SDL_Color stroke_color, int stroke_width) {
    if (TTF_Init() == -1) {
        ss_log_e("TTF_Init failed: %s", TTF_GetError());
        return TD_FAILURE;
    }

    pthread_mutex_lock(&g_mux);



    // ÈáçÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
    TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
    TTF_SetFontOutline(font, 0);
    TTF_SetFontKerning(font, 1);

    // ‰øÆÂ§çÔºö‰ΩøÁî®Ê†∑ÂºèÁÆ°ÁêÜÂáΩÊï∞
    if (ensure_font_style_normal(font) != TD_SUCCESS) {
        ss_log_e("Êó†Ê≥ïËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè‰∏∫Ê≠£Â∏∏");
        TTF_CloseFont(font);
        pthread_mutex_unlock(&g_mux);
        return TD_FAILURE;
    }

    // È¢ùÂ§ñÈ™åËØÅ
    verify_font_state(font);
    
    // ÂÖàÊ∏≤ÊüìÊèèËæπÔºàÂú®Â§ö‰∏™ÊñπÂêëÂÅèÁßªÊ∏≤ÊüìÔºâ
    SDL_Surface *stroke_surface = NULL;
    SDL_Surface *final_surface = NULL;
    
    // ËÆ°ÁÆó‰∏¥Êó∂Ë°®Èù¢Â§ßÂ∞èÔºàËÄÉËôëÊèèËæπÂÆΩÂ∫¶Ôºâ
    //SDL_Surface *sample = TTF_RenderUTF8_Solid(font, data, fg_color);//‰∏çÊäóÈîØÈΩøÔºåÁÆÄÂåñÁâà
    SDL_Surface *sample = TTF_RenderUTF8_Blended(font, data, fg_color);
    if (!sample) {
        ss_log_e("TTF_RenderUTF8_Blended failed: %s", TTF_GetError());
        return TD_FAILURE;
    }

    int actual_width = sample->w + stroke_width * 2;
    int actual_height = sample->h + stroke_width * 2;
    SDL_FreeSurface(sample);
    
    // ÂÆö‰πâ32‰ΩçÊ†ºÂºèÊé©Á†ÅÔºàÁî®‰∫é‰∏≠Èó¥ÂêàÊàêÔºâ
    Uint32 rmask32 = 0x00FF0000, gmask32 = 0x0000FF00, bmask32 = 0x000000FF, amask32 = 0xFF000000;
    
    // ÂàõÂª∫32‰Ωç‰∏¥Êó∂Ë°®Èù¢Áî®‰∫éÂêàÊàê
    final_surface = SDL_CreateRGBSurface(0, actual_width, actual_height, 32,
                                       rmask32, gmask32, bmask32, amask32);
    

    if (!final_surface) {
        ss_log_e("ÂàõÂª∫‰∏¥Êó∂Ë°®Èù¢Â§±Ë¥•: %s", SDL_GetError());
        return TD_FAILURE;
    }
    
    // ËÆæÁΩÆË°®Èù¢Ê∑∑ÂêàÊ®°Âºè‰∏∫ÈÄèÊòé
    SDL_SetSurfaceBlendMode(final_surface, SDL_BLENDMODE_BLEND);
    
    // Âú®8‰∏™ÊñπÂêëÊ∏≤ÊüìÊèèËæπ
    for (int x = -stroke_width; x <= stroke_width; x++) {
        for (int y = -stroke_width; y <= stroke_width; y++) {
            if (x == 0 && y == 0) continue;
            
            stroke_surface = TTF_RenderUTF8_Solid(font, data, stroke_color);
            if (stroke_surface) {
                SDL_Rect dst_rect = {stroke_width + x, stroke_width + y, 
                                   stroke_surface->w, stroke_surface->h};
                SDL_BlitSurface(stroke_surface, NULL, final_surface, &dst_rect);
                SDL_FreeSurface(stroke_surface);
            }
        }
    }
    
    // Ê∏≤Êüì‰∏ª‰ΩìÊñáÂ≠óÔºàË¶ÜÁõñÂú®ÊèèËæπ‰πã‰∏äÔºâ
    //SDL_Surface *text_surface = TTF_RenderUTF8_Solid(font, data, fg_color);
    SDL_Surface *text_surface = TTF_RenderUTF8_Blended(font, data, fg_color);
    if (text_surface) {
        SDL_Rect text_rect = {stroke_width, stroke_width, 
                             text_surface->w, text_surface->h};
        SDL_BlitSurface(text_surface, NULL, final_surface, &text_rect);
        SDL_FreeSurface(text_surface);
    }
    
    // ÂÆö‰πâ16‰ΩçÊ†ºÂºèÊé©Á†ÅÔºàÊúÄÁªàËæìÂá∫Ôºâ
    Uint32 rmask16 = 0x7C00, gmask16 = 0x03E0, bmask16 = 0x001F, amask16 = 0x8000;
    
    // ÂàõÂª∫16‰ΩçÁõÆÊ†áË°®Èù¢
    SDL_Surface *target_16bit_surface = SDL_CreateRGBSurface(0, final_surface->w, 
                                                             final_surface->h, 16,
                                                             rmask16, gmask16, bmask16, amask16);
    if (!target_16bit_surface) {
        SDL_FreeSurface(final_surface);
        return TD_FAILURE;
    }
    
    // Â∞Ü32‰ΩçËΩ¨Êç¢‰∏∫16‰Ωç
    if (convert_32bit_to_16bit(final_surface, target_16bit_surface) != TD_SUCCESS) {
        ss_log_e("32‰ΩçÂà∞16‰ΩçËΩ¨Êç¢Â§±Ë¥•");
        SDL_FreeSurface(final_surface);
        SDL_FreeSurface(target_16bit_surface);
        return TD_FAILURE;
    }
    
    // Â§çÂà∂Êï∞ÊçÆÂà∞osd_bmp
    size_t buffer_size = target_16bit_surface->pitch * target_16bit_surface->h;
    osd_bmp->data = malloc(buffer_size);
    if (!osd_bmp->data) {
        SDL_FreeSurface(final_surface);
        SDL_FreeSurface(target_16bit_surface);
        return TD_FAILURE;
    }
    
    memcpy(osd_bmp->data, target_16bit_surface->pixels, buffer_size);
    osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
    osd_bmp->width = target_16bit_surface->w;
    osd_bmp->height = target_16bit_surface->h;
    osd_bmp->pitch = target_16bit_surface->pitch;
    
    // üîß ‰ºòÂåñÔºöÂ≠òÂÇ®Ê∏≤ÊüìÂèÇÊï∞ÔºàÂ∏¶ÊèèËæπÁöÑÂçïË°åÊñáÊú¨Ôºâ
    osd_bmp->text_color = fg_color;
    osd_bmp->stroke_color = stroke_color;
    osd_bmp->stroke_width = stroke_width;
    osd_bmp->font_size = TTF_FontHeight(font); // Ëé∑ÂèñÂ≠ó‰ΩìÈ´òÂ∫¶‰Ωú‰∏∫Â≠óÂè∑
    osd_bmp->alignment = ALIGN_LEFT; // ÂçïË°åÊñáÊú¨ÈªòËÆ§Â∑¶ÂØπÈΩê
    osd_bmp->line_spacing = 0; // ÂçïË°åÊñáÊú¨Êó†Ë°åË∑ù
    osd_bmp->has_stroke = 1;
    
    // ÂàùÂßãÂåñË∞ÉËâ≤ÊùøÂíåÊèèËæπÊé©Á†Å
    osd_bmp->palette = NULL;
    osd_bmp->palette_size = 0;
    osd_bmp->stroke_mask = NULL;
    
    ss_log_d("ÊèèËæπÊñáÊú¨Ê∏≤ÊüìÂèÇÊï∞Â∑≤Â≠òÂÇ®: ÊñáÂ≠óÈ¢úËâ≤(%d,%d,%d,%d), ÊèèËæπÈ¢úËâ≤(%d,%d,%d,%d), ÊèèËæπÂÆΩÂ∫¶=%d, Â≠óÂè∑=%d", 
            osd_bmp->text_color.r, osd_bmp->text_color.g, osd_bmp->text_color.b, osd_bmp->text_color.a,
            osd_bmp->stroke_color.r, osd_bmp->stroke_color.g, osd_bmp->stroke_color.b, osd_bmp->stroke_color.a,
            osd_bmp->stroke_width, osd_bmp->font_size);

    
    // ÈáäÊîæËµÑÊ∫ê
    SDL_FreeSurface(final_surface);
    SDL_FreeSurface(target_16bit_surface);

    pthread_mutex_unlock(&g_mux);
    
    TTF_Quit();
    return TD_SUCCESS;
}


/**
 * @brief ÂàÜÂâ≤ÊñáÊú¨‰∏∫Â§öË°å
 */
static int split_text_lines(const char *text, char ***lines, int *line_count) {
    if (!text || !lines || !line_count) return TD_FAILURE;
    
    // ËÆ°ÁÆóË°åÊï∞
    *line_count = 1;
    for (const char *p = text; *p; p++) {
        if (*p == '\n') (*line_count)++;
    }
    

    // Ê∑ªÂä†Êó•ÂøóÔºöËÆ∞ÂΩïË°åÊï∞
    ss_log_d("ÂàÜÂâ≤ÊñáÊú¨Ë°åÊï∞: %d", *line_count);
    
    // Ê∑ªÂä†ÂÜÖÂ≠òÂàÜÈÖçÊ£ÄÊü•
    *lines = malloc(sizeof(char*) * (*line_count));
    if (!*lines) {
        ss_log_e("ÂàÜÈÖçË°åÊåáÈíàÊï∞ÁªÑÂ§±Ë¥•");
        return TD_FAILURE;
    }

    // Â§çÂà∂ÊñáÊú¨Âπ∂ÂàÜÂâ≤
    char *text_copy = strdup(text);
    if (!text_copy) {
        ss_log_e("Â§çÂà∂ÊñáÊú¨Â§±Ë¥•");
        free(*lines);
        *lines = NULL;
        return TD_FAILURE;
    }

    int i = 0;
    char *token = strtok(text_copy, "\n");
    while (token != NULL && i < *line_count) {
        // Ê∑ªÂä†Êó•ÂøóÔºöËÆ∞ÂΩïÊØèË°åÂÜÖÂÆπ
        ss_log_d("ÂàÜÂâ≤Ë°å %d: %s", i, token);
        (*lines)[i] = strdup(token);
        if (!(*lines)[i]) {
            ss_log_e("ÂàÜÈÖçË°å %d ÂÜÖÂ≠òÂ§±Ë¥•", i);
            // Ê∏ÖÁêÜÂ∑≤ÂàÜÈÖçÁöÑÂÜÖÂ≠ò
            for (int j = 0; j < i; j++) free((*lines)[j]);
            free(*lines);
            free(text_copy);
            return TD_FAILURE;
        }
        i++;
        token = strtok(NULL, "\n");
    }
    
    free(text_copy);
    return TD_SUCCESS;
}

/**
 * @brief ËÆ°ÁÆóÂ§öË°åÊñáÊú¨ÁöÑÂ∞∫ÂØ∏
 */
static int calculate_multiline_size(TTF_Font *font, char **lines, int line_count, 
                                   int *max_width, int *total_height, int line_spacing) {
    *max_width = 0;
    *total_height = 0;

    // üîß ‰øÆÂ§çÔºöÂú®Âæ™ÁéØÂâçÁ°Æ‰øùÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏
    if (ensure_font_style_normal(font) != TD_SUCCESS) {
        ss_log_e("ËÆ°ÁÆóÂ∞∫ÂØ∏Êó∂Êó†Ê≥ïËÆæÁΩÆÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏");
        return TD_FAILURE;
    }
    
    for (int i = 0; i < line_count; i++) {
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);

        // üîß Ê∑ªÂä†ÈïøÂ∫¶ÈôêÂà∂
        if (strlen(lines[i]) > 256) {
            ss_log_e("Ë°å %d ËøáÈïø: %zu Â≠óÁ¨¶", i, strlen(lines[i]));
            return TD_FAILURE;
        }

        if (!lines[i]) {
            ss_log_e("Á¨¨ %d Ë°å‰∏∫Á©∫", i);
            return TD_FAILURE;
        }

        // üîß ‰øÆÂ§çÔºöÊØèÊ¨°Ê∏≤ÊüìÂâçÁ°Æ‰øùÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏
        if (ensure_font_style_normal(font) != TD_SUCCESS) {
            ss_log_e("Ê∏≤ÊüìË°å %d ÂâçÊó†Ê≥ïËÆæÁΩÆÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏", i);
            return TD_FAILURE;
        }
        // È¢ùÂ§ñÈ™åËØÅ
        verify_font_state(font);

        SDL_Color sample_color = {255, 255, 255, 255};
        SDL_Surface *sample = TTF_RenderUTF8_Blended(font, lines[i], sample_color);
        if (sample) {

            // üîß Ê∑ªÂä†ÊúÄÂ§ßÂ∞∫ÂØ∏ÈôêÂà∂
            if (sample->w > 4096 || sample->h > 4096) {
                ss_log_e("Ë°å %d Â∞∫ÂØ∏ËøáÂ§ß: %dx%d", i, sample->w, sample->h);
                SDL_FreeSurface(sample);
                return TD_FAILURE;
            }

            ss_log_d("Ë°å %d Â∞∫ÂØ∏: %dx%d", i, sample->w, sample->h);
            if (sample->w > *max_width) *max_width = sample->w;
            *total_height += sample->h;
            SDL_FreeSurface(sample);
        }else {
            ss_log_e("Ê∏≤ÊüìË°å %d Â§±Ë¥•: %s", i, TTF_GetError());
            return TD_FAILURE;
        }
    }
    
    // Ê∑ªÂä†Ë°åÈó¥Ë∑ù
    if (line_count > 1) {
        *total_height += line_spacing * (line_count - 1);
    }
    
    // üîß ‰øÆÂ§çÔºöÊ∑ªÂä†ÂÆâÂÖ®ËæπË∑ùÔºàÈò≤Ê≠¢Ë£ÅÂâ™Ôºâ
    *total_height += 2; // ‰∏ä‰∏ãÂêÑÂä†1ÂÉèÁ¥†ÂÆâÂÖ®ËæπË∑ù
    
    ss_log_d("ËÆ°ÁÆóÂ∞∫ÂØ∏: %dx%d, Ë°åÊï∞: %d, Ë°åË∑ù: %d", *max_width, *total_height, line_count, line_spacing);
    return TD_SUCCESS;
}

/**
 * @brief Ê∏≤ÊüìÂ§öË°åÊñáÊú¨ÔºàÊó†ÊèèËæπÔºâ
 */
static int render_multiline_text(TTF_Font *font, SDL_Color fg_color, char **lines, 
                                int line_count, SDL_Surface *target_surface,
                                TextAlignment alignment, int line_spacing) {

    // üîß Á°Æ‰øùÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏
    if (ensure_font_style_normal(font) != TD_SUCCESS) {
        return TD_FAILURE;
    }

    // üîß ‰øÆÂ§çÔºöËÄÉËôëÂÆâÂÖ®ËæπË∑ù
    int current_y = 1; // È°∂ÈÉ®ÂÆâÂÖ®ËæπË∑ù
    
    for (int i = 0; i < line_count; i++) {
        // ‰øÆÂ§çÔºöÊØèÊ¨°Ê∏≤ÊüìÂâçÂº∫Âà∂ËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
        if (strlen(lines[i]) > 256) {
            ss_log_e("Ë°å %d ËøáÈïø: %zu Â≠óÁ¨¶", i, strlen(lines[i]));
            return TD_FAILURE;
        }
        SDL_Surface *line_surface = TTF_RenderUTF8_Blended(font, lines[i], fg_color);
        if (line_surface) {
            int x = 0;
            switch (alignment) {
                case ALIGN_CENTER:
                    x = (target_surface->w - line_surface->w) / 2;
                    break;
                case ALIGN_RIGHT:
                    x = target_surface->w - line_surface->w;
                    break;
                case ALIGN_LEFT:
                default:
                    x = 0;
                    break;
            }

            // üîß ‰øÆÂ§çÔºöÊ£ÄÊü•YÂùêÊ†áÊòØÂê¶Ë∂ÖÂá∫ËæπÁïå
            if (current_y + line_surface->h > target_surface->h) {
                ss_log_e("Ë°å %d Ë∂ÖÂá∫ËæπÁïå: Y=%d, È´òÂ∫¶=%d, Ë°®Èù¢È´òÂ∫¶=%d", 
                        i, current_y, line_surface->h, target_surface->h);
                SDL_FreeSurface(line_surface);
                return TD_FAILURE;
            }
            
            SDL_Rect dst_rect = {x, current_y, line_surface->w, line_surface->h};
            SDL_BlitSurface(line_surface, NULL, target_surface, &dst_rect);
            SDL_FreeSurface(line_surface);
            
            current_y += line_surface->h;
            if (i < line_count - 1) { // ‰∏çÊòØÊúÄÂêé‰∏ÄË°åÊâçÂä†Ë°åÈó¥Ë∑ù
                current_y += line_spacing;
            }
        }
    }
    
    return TD_SUCCESS;
}

/**
 * @brief Ê∏≤ÊüìÂ∏¶ÊèèËæπÁöÑÂ§öË°åÊñáÊú¨
 */
static int render_multiline_text_with_stroke(TTF_Font *font, SDL_Color fg_color, 
                                           char **lines, int line_count, 
                                           SDL_Surface *target_surface,
                                           SDL_Color stroke_color, int stroke_width,
                                           TextAlignment alignment, int line_spacing) {
    // üîß Á°Æ‰øùÂ≠ó‰ΩìÊ†∑ÂºèÊ≠£Â∏∏
    if (ensure_font_style_normal(font) != TD_SUCCESS) {
        return TD_FAILURE;
    }
    int current_y = stroke_width; // üîß ‰øÆÂ§çÔºöËµ∑Âßã‰ΩçÁΩÆËÄÉËôëÊèèËæπÂÆΩÂ∫¶
    
    for (int i = 0; i < line_count; i++) {
        if (strlen(lines[i]) > 256) {
            ss_log_e("Ë°å %d ËøáÈïø: %zu Â≠óÁ¨¶", i, strlen(lines[i]));
            return TD_FAILURE;
        }
        // ÂÖàÊ∏≤ÊüìÊèèËæπ
        for (int offset = 1; offset <= stroke_width; offset++) {
            // Âè™Ê∏≤ÊüìÂ§ñÂúàÊèèËæπÔºåÂáèÂ∞ëÊ∏≤ÊüìÊ¨°Êï∞
            for (int dir = 0; dir < 8; dir++) {
                // üîß ‰øÆÂ§çÔºöÊØèÊ¨°Ê∏≤ÊüìÊèèËæπÂâçÂº∫Âà∂ËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
                TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
                int x = 0, y = 0;
                switch (dir) {
                    case 0: x = offset; y = 0; break;     // Âè≥
                    case 1: x = -offset; y = 0; break;    // Â∑¶
                    case 2: x = 0; y = offset; break;    // ‰∏ã
                    case 3: x = 0; y = -offset; break;    // ‰∏ä
                    case 4: x = offset; y = offset; break;   // Âè≥‰∏ã
                    case 5: x = -offset; y = offset; break;  // Â∑¶‰∏ã
                    case 6: x = offset; y = -offset; break;  // Âè≥‰∏ä
                    case 7: x = -offset; y = -offset; break; // Â∑¶‰∏ä
                }
                
                SDL_Surface *stroke_surface = TTF_RenderUTF8_Solid(font, lines[i], stroke_color);
                if (stroke_surface) {
                    int align_x = 0;
                    switch (alignment) {
                        case ALIGN_CENTER:
                            align_x = (target_surface->w - stroke_surface->w) / 2;
                            break;
                        case ALIGN_RIGHT:
                            align_x = target_surface->w - stroke_surface->w;
                            break;
                        case ALIGN_LEFT:
                        default:
                            align_x = 0;
                            break;
                    }
                    
                    SDL_Rect dst_rect = {align_x + x + stroke_width, 
                                       current_y + y + stroke_width, 
                                       stroke_surface->w, stroke_surface->h};
                    SDL_BlitSurface(stroke_surface, NULL, target_surface, &dst_rect);
                    SDL_FreeSurface(stroke_surface);
                }
            }
        }
        
        // Ê∏≤Êüì‰∏ª‰ΩìÊñáÂ≠ó
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
        SDL_Surface *text_surface = TTF_RenderUTF8_Blended(font, lines[i], fg_color);
        if (text_surface) {
            int align_x = 0;
            switch (alignment) {
                case ALIGN_CENTER:
                    align_x = (target_surface->w - text_surface->w) / 2;
                    break;
                case ALIGN_RIGHT:
                    align_x = target_surface->w - text_surface->w;
                    break;
                case ALIGN_LEFT:
                default:
                    align_x = 0;
                    break;
            }

            // üîß ‰øÆÂ§çÔºöÊ£ÄÊü•ËæπÁïå
            if (current_y + text_surface->h > target_surface->h - stroke_width) {
                ss_log_e("ÊèèËæπÊñáÊú¨Ë°å %d Ë∂ÖÂá∫ËæπÁïå: Y=%d, È´òÂ∫¶=%d", i, current_y, text_surface->h);
                SDL_FreeSurface(text_surface);
                return TD_FAILURE;
            }
            
            SDL_Rect text_rect = {align_x + stroke_width, 
                                current_y + stroke_width, 
                                text_surface->w, text_surface->h};
            SDL_BlitSurface(text_surface, NULL, target_surface, &text_rect);
            SDL_FreeSurface(text_surface);
        }
        
        // üîß ‰øÆÂ§çÔºöÊ≠£Á°ÆÊõ¥Êñ∞YÂùêÊ†áÔºàËÄÉËôëÊèèËæπÂíåË°åÈó¥Ë∑ùÔºâ
        SDL_Surface *sample = TTF_RenderUTF8_Blended(font, lines[i], fg_color);
        if (sample) {
            current_y += sample->h;
            if (i < line_count - 1) { // ‰∏çÊòØÊúÄÂêé‰∏ÄË°å
                current_y += line_spacing;
            }
            SDL_FreeSurface(sample);
        }
    }
    
    return TD_SUCCESS;
}

/**
 * @brief Â§öË°åÊñáÊú¨Ê∏≤Êüì‰∏ªÂáΩÊï∞ÔºàÊîØÊåÅÂØπÈΩêÂíåÊèèËæπÔºâ
 */
int ttf_get_multiline_bmp(ot_bmpp *osd_bmp, const char *osd_buf, SDL_Color color, 
                         int32_t fontSize, SDL_Color *stroke_color, int stroke_width,
                         TextAlignment alignment, int line_spacing) {
    
    int ret = TD_FAILURE;
    
    // Á°Æ‰øùTTFÂ∑≤ÂàùÂßãÂåñ
    pthread_mutex_lock(&g_mux);
    ss_log_d("ÂàùÂßãÂåñTTFÂ∫ì");
    if (TTF_Init() == -1) {
        ss_log_e("TTF_Init failed: %s", TTF_GetError());
        pthread_mutex_unlock(&g_mux);
        return TD_FAILURE;
    }
    ss_log_d("TTFÂ∫ìÂàùÂßãÂåñÂÆåÊàê");
    
    // Áõ¥Êé•Âä†ËΩΩÂ≠ó‰Ωì
    const char *font_path = DEFAULT_FONT_PATH;

    TTF_Font *font = TTF_OpenFont(font_path, fontSize);
    
    // Â¶ÇÊûúÈªòËÆ§Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®Â≠ó‰Ωì
    if (!font && strcmp(font_path, FALLBACK_FONT_PATH) != 0) {
        ss_log_w("ÈªòËÆ§Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®Â≠ó‰Ωì: %s", FALLBACK_FONT_PATH);
        font = TTF_OpenFont(FALLBACK_FONT_PATH, fontSize);
    }
    
    if (!font) {
        ss_log_e("Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•");
        pthread_mutex_unlock(&g_mux);
        return TD_FAILURE;
    }
    
    pthread_mutex_unlock(&g_mux);

    if (!font) {
        ss_log_e("Êó†Ê≥ïÊâìÂºÄÂ≠ó‰ΩìÊñá‰ª∂: %s, Â≠óÂè∑: %d", DEFAULT_FONT_PATH, fontSize);
        return TD_FAILURE;
    }

    // Ê∑ªÂä†Êó•ÂøóÔºöËÆ∞ÂΩïËæìÂÖ•ÂèÇÊï∞
    ss_log_d("Ê∏≤ÊüìÂ§öË°åÊñáÂ≠ó: %s, Â≠óÂè∑: %d, ÂØπÈΩê: %d, Ë°åË∑ù: %d", 
             osd_buf, fontSize, alignment, line_spacing);

    // üîß ‰øÆÂ§çÔºöÂΩªÂ∫ïÈáçÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
    TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
    
    // ‰∏âÈáç‰øùÈô©ÔºöÂ§öÊ¨°ËÆæÁΩÆ‰ª•Á°Æ‰øùÁîüÊïà
    for (int i = 0; i < 3; i++) {
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
    }
    
    // È™åËØÅÊ†∑ÂºèËÆæÁΩÆ
    int current_style = TTF_GetFontStyle(font);
    if (current_style != TTF_STYLE_NORMAL) {
        ss_log_e("Â≠ó‰ΩìÊ†∑ÂºèËÆæÁΩÆÂ§±Ë¥•: %d", current_style);
        return TD_FAILURE;
    }

    
    // ÂàÜÂâ≤ÊñáÊú¨‰∏∫Â§öË°å
    char **lines = NULL;
    int line_count = 0;
    if (split_text_lines(osd_buf, &lines, &line_count) != TD_SUCCESS) {
        ss_log_e("ÂàÜÂâ≤ÊñáÊú¨Ë°åÂ§±Ë¥•");
        return TD_FAILURE;
    }

    
    // // Ê£ÄÊü•Ë°åÊï∞ÊòØÂê¶ÂêàÁêÜ
    // if (line_count > 20) {
    //     ss_log_e("Ë°åÊï∞ËøáÂ§ö: %d", line_count);
    //     for (int i = 0; i < line_count; i++) free(lines[i]);
    //     free(lines);
    //     return TD_FAILURE;
    // }
    
    // ËÆ°ÁÆóÂ§öË°åÊñáÊú¨Â∞∫ÂØ∏
    int max_width = 0, total_height = 0;
    if (calculate_multiline_size(font, lines, line_count, &max_width, &total_height, line_spacing) != TD_SUCCESS) {
        ss_log_e("ËÆ°ÁÆóÂ§öË°åÊñáÊú¨Â∞∫ÂØ∏Â§±Ë¥•");
        for (int i = 0; i < line_count; i++) free(lines[i]);
        free(lines);
        return TD_FAILURE;
    }

    // Ê£ÄÊü•Â∞∫ÂØ∏ÊòØÂê¶ÂêàÁêÜ
    if (max_width > 4096 || total_height > 4096) {
        ss_log_e("ÊñáÊú¨Â∞∫ÂØ∏ËøáÂ§ß: %dx%d", max_width, total_height);
        for (int i = 0; i < line_count; i++) free(lines[i]);
        free(lines);
        return TD_FAILURE;
    }
    
    // ËÄÉËôëÊèèËæπÂÆΩÂ∫¶
    if (stroke_color && stroke_width > 0) {
        max_width += stroke_width * 2;
        total_height += stroke_width * 2;
    }
    
    // ÂàõÂª∫32‰ΩçË°®Èù¢Áî®‰∫éÂêàÊàê
    Uint32 rmask32 = 0x00FF0000, gmask32 = 0x0000FF00, bmask32 = 0x000000FF, amask32 = 0xFF000000;
    SDL_Surface *final_32bit_surface = SDL_CreateRGBSurface(0, max_width, total_height, 32,
                                                           rmask32, gmask32, bmask32, amask32);
    if (!final_32bit_surface) {
        ss_log_e("ÂàõÂª∫Â§öË°åÊñáÊú¨Ë°®Èù¢Â§±Ë¥•");
        for (int i = 0; i < line_count; i++) free(lines[i]);
        free(lines);
        return TD_FAILURE;
    }
    
    SDL_SetSurfaceBlendMode(final_32bit_surface, SDL_BLENDMODE_BLEND);

    
    
    // Ê∏≤ÊüìÂ§öË°åÊñáÊú¨
    if (stroke_color && stroke_width > 0) {
        ret = render_multiline_text_with_stroke(font, color, lines, line_count, 
                                               final_32bit_surface, *stroke_color, stroke_width,
                                               alignment, line_spacing);
    } else {
        ret = render_multiline_text(font, color, lines, line_count, 
                                   final_32bit_surface, alignment, line_spacing);
    }
    
    // Ê∏ÖÁêÜË°åÊï∞ÊçÆ
    for (int i = 0; i < line_count; i++) free(lines[i]);
    free(lines);
    
    if (ret == TD_SUCCESS) {
        // ËΩ¨Êç¢‰∏∫16‰ΩçÊ†ºÂºè
        Uint32 rmask16 = 0x7C00, gmask16 = 0x03E0, bmask16 = 0x001F, amask16 = 0x8000;
        SDL_Surface *target_16bit_surface = SDL_CreateRGBSurface(0, final_32bit_surface->w, 
                                                                 final_32bit_surface->h, 16,
                                                                 rmask16, gmask16, bmask16, amask16);
        if (target_16bit_surface) {
            if (convert_32bit_to_16bit(final_32bit_surface, target_16bit_surface) == TD_SUCCESS) {
                size_t buffer_size = target_16bit_surface->pitch * target_16bit_surface->h;
                osd_bmp->data = malloc(buffer_size);
                if (osd_bmp->data) {
                    memcpy(osd_bmp->data, target_16bit_surface->pixels, buffer_size);
                    osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
                    osd_bmp->width = target_16bit_surface->w;
                    osd_bmp->height = target_16bit_surface->h;
                    osd_bmp->pitch = target_16bit_surface->pitch;
                    
                    // üîß ‰ºòÂåñÔºöÂ≠òÂÇ®Ê∏≤ÊüìÂèÇÊï∞Âà∞ot_bmppÁªìÊûÑ‰Ωì
                    osd_bmp->text_color = color;
                    osd_bmp->font_size = fontSize;
                    osd_bmp->alignment = alignment;
                    osd_bmp->line_spacing = line_spacing;
                    
                    if (stroke_color && stroke_width > 0) {
                        osd_bmp->stroke_color = *stroke_color;
                        osd_bmp->stroke_width = stroke_width;
                        osd_bmp->has_stroke = 1;
                    } else {
                        osd_bmp->stroke_width = 0;
                        osd_bmp->has_stroke = 0;
                        // ËÆæÁΩÆÈªòËÆ§ÊèèËæπÈ¢úËâ≤ÔºàÈªëËâ≤Ôºâ
                        osd_bmp->stroke_color = (SDL_Color){0, 0, 0, 255};
                    }
                    
                    ret = TD_SUCCESS;
                    ss_log_d("Ê∏≤ÊüìÂèÇÊï∞Â∑≤Â≠òÂÇ®: È¢úËâ≤(%d,%d,%d,%d), Â≠óÂè∑=%d, ÂØπÈΩê=%d, Ë°åË∑ù=%d, ÊèèËæπ=%s", 
                            osd_bmp->text_color.r, osd_bmp->text_color.g, osd_bmp->text_color.b, osd_bmp->text_color.a,
                            osd_bmp->font_size, osd_bmp->alignment, osd_bmp->line_spacing,
                            osd_bmp->has_stroke ? "ÊòØ" : "Âê¶");
                }
            }
            SDL_FreeSurface(target_16bit_surface);
        }
    }
    
    SDL_FreeSurface(final_32bit_surface);
    
    // ÈáäÊîæÂ≠ó‰ΩìÂºïÁî®
    pthread_mutex_lock(&g_mux);
    
    pthread_mutex_unlock(&g_mux);

    // Âú®ttf_get_multiline_bmpÂáΩÊï∞Êú´Â∞æÊ∑ªÂä†È™åËØÅ
    ss_log_d("ÁîüÊàêÁöÑ‰ΩçÂõæ: %dx%d, Ê†ºÂºè: %s, Ê≠•Èïø: %d", 
         osd_bmp->width, osd_bmp->height,
         (osd_bmp->pixel_format == OT_PIXEL_FORMAT_ARGB_1555) ? "16‰ΩçARGB1555" : "ÂÖ∂‰ªñÊ†ºÂºè",
         osd_bmp->pitch);
    
    return ret;
}



/**
 * @brief Á°Æ‰øùÂ≠ó‰ΩìÊ†∑Âºè‰∏∫Ê≠£Â∏∏Ê†∑Âºè
 * @param font Â≠ó‰ΩìÂØπË±°ÊåáÈíà
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
static int ensure_font_style_normal(TTF_Font *font) {
    if (!font) {
        ss_log_e("Â≠ó‰ΩìÊåáÈíà‰∏∫Á©∫");
        return TD_FAILURE;
    }
    
    // Âº∫Âà∂ËÆæÁΩÆ‰∏∫Ê≠£Â∏∏
    TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
    
    // ‰∫îÈáç‰øùÈô©ÔºöÂ§öÊ¨°ËÆæÁΩÆ‰ª•Á°Æ‰øùÁîüÊïà
    for (int i = 0; i < 5; i++) {
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
        // Ê∑ªÂä†ÂæÆÂ∞èÂª∂ËøüÔºåÁ°Æ‰øùËÆæÁΩÆÁîüÊïà
        usleep(1000); // 1ÊØ´ÁßíÂª∂Ëøü
    }
    
    // È™åËØÅËÆæÁΩÆ
    int verified_style = TTF_GetFontStyle(font);
    if (verified_style != TTF_STYLE_NORMAL) {
        ss_log_e("Â≠ó‰ΩìÊ†∑ÂºèËÆæÁΩÆÂ§±Ë¥•: %d", verified_style);
        
        // üîß ‰øÆÂ§çÔºöÂ∞ùËØïÁªàÊûÅ‰øÆÂ§ç - ÂÆåÂÖ®ÈáçÊñ∞ÂàùÂßãÂåñ
        int fontSize = TTF_FontHeight(font);
        const char *fontPath = "/root/app/SimHei.ttf";
        
        // ‰ΩøÁî®ËøîÂõûÂÄºËøõË°åÊó•ÂøóËÆ∞ÂΩï
        ss_log_e("Â≠ó‰ΩìÊ†∑Âºè‰∏•ÈáçÈîôËØØÔºåÂΩìÂâçÂ≠ó‰ΩìÈ´òÂ∫¶: %dÔºåÂª∫ËÆÆÂÆåÂÖ®ÈáçÊñ∞ÂàùÂßãÂåñÂ≠ó‰ΩìÁ≥ªÁªü", fontSize);
        return TD_FAILURE;
    }
    
    return TD_SUCCESS;
}




/**
 * @brief ‰ªéBMPÊñá‰ª∂Âä†ËΩΩÂõæÂÉèÊï∞ÊçÆÂà∞ot_bmppÁªìÊûÑ
 * @param filename BMPÊñá‰ª∂Ë∑ØÂæÑ
 * @param osd_bmp Â≠òÂÇ®ÂõæÂÉèÊï∞ÊçÆÁöÑÁªìÊûÑ‰ΩìÊåáÈíà
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int bmp_load_file(const char *filename, ot_bmpp *osd_bmp) {
    if (!filename || !osd_bmp) {
        ss_log_e("ÂèÇÊï∞ÈîôËØØ: Êñá‰ª∂ÂêçÊàñËæìÂá∫ÁªìÊûÑ‰∏∫Á©∫");
        return TD_FAILURE;
    }
    
    // Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
    if (access(filename, F_OK) != 0) {
        ss_log_e("Êñá‰ª∂‰∏çÂ≠òÂú®: %s", filename);
        return TD_FAILURE;
    }
    
    FILE *file = fopen(filename, "rb");
    if (!file) {
        ss_log_e("Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂: %s", filename);
        return TD_FAILURE;
    }
    
    // ËØªÂèñÊñá‰ª∂Â§¥
    BMPFileHeader file_header;
    if (fread(&file_header, sizeof(BMPFileHeader), 1, file) != 1) {
        ss_log_e("ËØªÂèñBMPÊñá‰ª∂Â§¥Â§±Ë¥•");
        fclose(file);
        return TD_FAILURE;
    }
    
    // Ê£ÄÊü•BMPÊñá‰ª∂Ê†áËØÜ
    if (file_header.bfType != 0x4D42) { // "BM"
        ss_log_e("‰∏çÊòØÊúâÊïàÁöÑBMPÊñá‰ª∂: Ê†áËØÜÁ¨¶=%04X", file_header.bfType);
        fclose(file);
        return TD_FAILURE;
    }
    
    // ËØªÂèñ‰ø°ÊÅØÂ§¥
    BMPInfoHeader info_header;
    if (fread(&info_header, sizeof(BMPInfoHeader), 1, file) != 1) {
        ss_log_e("ËØªÂèñBMP‰ø°ÊÅØÂ§¥Â§±Ë¥•");
        fclose(file);
        return TD_FAILURE;
    }
    
    // Ê£ÄÊü•ÊîØÊåÅÁöÑÊ†ºÂºè
    if (info_header.biCompression != 0) {
        ss_log_e("‰∏çÊîØÊåÅÂéãÁº©ÁöÑBMPÊ†ºÂºè: ÂéãÁº©Á±ªÂûã=%u", info_header.biCompression);
        fclose(file);
        return TD_FAILURE;
    }
    
    ss_log_d("BMPÊñá‰ª∂‰ø°ÊÅØ: %dx%d, ‰ΩçÊ∑±=%d, Â§ßÂ∞è=%uÂ≠óËäÇ", 
             info_header.biWidth, info_header.biHeight, 
             info_header.biBitCount, file_header.bfSize);
    
    // üîß ‰ºòÂåñÔºöÂàùÂßãÂåñÊâÄÊúâÂ≠óÊÆµ
    osd_bmp->palette = NULL;
    osd_bmp->palette_size = 0;
    osd_bmp->stroke_mask = NULL;
    
    // ÂàùÂßãÂåñÊ∏≤ÊüìÂèÇÊï∞Â≠óÊÆµÔºà‰ªéÊñá‰ª∂Âä†ËΩΩÊó∂ËÆæ‰∏∫ÈªòËÆ§ÂÄºÔºâ
    osd_bmp->text_color = (SDL_Color){255, 255, 255, 255}; // ÈªòËÆ§ÁôΩËâ≤
    osd_bmp->stroke_color = (SDL_Color){0, 0, 0, 255}; // ÈªòËÆ§ÈªëËâ≤ÊèèËæπ
    osd_bmp->stroke_width = 0;
    osd_bmp->font_size = 0; // ‰ªéÊñá‰ª∂Âä†ËΩΩÊó∂Êó†Ê≥ïÁ°ÆÂÆöÂ≠óÂè∑
    osd_bmp->alignment = ALIGN_LEFT; // ÈªòËÆ§Â∑¶ÂØπÈΩê
    osd_bmp->line_spacing = 0;
    osd_bmp->has_stroke = 0;
    
    // ËØªÂèñÈ¢úËâ≤Ë°®Ôºà‰ªÖÈÄÇÁî®‰∫é1/4/8‰ΩçËâ≤Ê∑±Ôºâ
    if (info_header.biBitCount <= 8 && info_header.biClrUsed > 0) {
        osd_bmp->palette_size = info_header.biClrUsed;
        osd_bmp->palette = malloc(osd_bmp->palette_size * sizeof(SDL_Color));
        if (!osd_bmp->palette) {
            ss_log_e("ÂàÜÈÖçÈ¢úËâ≤Ë°®ÂÜÖÂ≠òÂ§±Ë¥•");
            fclose(file);
            return TD_FAILURE;
        }
        
        // ËØªÂèñÈ¢úËâ≤Ë°®Êï∞ÊçÆ
        if (fread(osd_bmp->palette, sizeof(SDL_Color), osd_bmp->palette_size, file) != osd_bmp->palette_size) {
            ss_log_e("ËØªÂèñÈ¢úËâ≤Ë°®Â§±Ë¥•");
            free(osd_bmp->palette);
            fclose(file);
            return TD_FAILURE;
        }
    }
    
    // üîß ‰ºòÂåñÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÊâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞
    size_t extended_data_size = file_header.bfOffBits - (sizeof(BMPFileHeader) + sizeof(BMPInfoHeader) + osd_bmp->palette_size * sizeof(SDL_Color));
    
    if (extended_data_size > 0) {
        // ËØªÂèñÊâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞
        SDL_Color text_color, stroke_color;
        int stroke_width, font_size, alignment, line_spacing, has_stroke;
        
        if (fread(&text_color, sizeof(SDL_Color), 1, file) != 1 ||
            fread(&stroke_color, sizeof(SDL_Color), 1, file) != 1 ||
            fread(&stroke_width, sizeof(int), 1, file) != 1 ||
            fread(&font_size, sizeof(int), 1, file) != 1 ||
            fread(&alignment, sizeof(int), 1, file) != 1 ||
            fread(&line_spacing, sizeof(int), 1, file) != 1 ||
            fread(&has_stroke, sizeof(int), 1, file) != 1) {
            ss_log_e("ËØªÂèñÊâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞Â§±Ë¥•");
        } else {
            // Â≠òÂÇ®Âà∞ot_bmppÁªìÊûÑ‰Ωì
            osd_bmp->text_color = text_color;
            osd_bmp->stroke_color = stroke_color;
            osd_bmp->stroke_width = stroke_width;
            osd_bmp->font_size = font_size;
            osd_bmp->alignment = (TextAlignment)alignment;
            osd_bmp->line_spacing = line_spacing;
            osd_bmp->has_stroke = has_stroke;
            
            ss_log_d("‰ªéBMPÊñá‰ª∂ËØªÂèñÊâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞: Â≠óÂè∑=%d, ÊèèËæπ=%s", 
                    osd_bmp->font_size, osd_bmp->has_stroke ? "ÊòØ" : "Âê¶");
        }
    }
    
    // ÂÆö‰ΩçÂà∞ÂÉèÁ¥†Êï∞ÊçÆ
    if (fseek(file, file_header.bfOffBits, SEEK_SET) != 0) {
        ss_log_e("ÂÆö‰ΩçÂà∞ÂÉèÁ¥†Êï∞ÊçÆÂ§±Ë¥•: ÂÅèÁßªÈáè=%u", file_header.bfOffBits);
        if (osd_bmp->palette) free(osd_bmp->palette);
        fclose(file);
        return TD_FAILURE;
    }
    
    // ËÆ°ÁÆóÊ≠•ÈïøÔºàÊØèË°åÂ≠óËäÇÊï∞ÔºåBMPÊñá‰ª∂Ë°åÂØπÈΩêÂà∞4Â≠óËäÇÔºâ
    int width = info_header.biWidth;
    int height = abs(info_header.biHeight); // È´òÂ∫¶ÂèØËÉΩ‰∏∫Ë¥üÔºàËá™‰∏äËÄå‰∏ãÂ≠òÂÇ®Ôºâ
    int src_stride = ((width * info_header.biBitCount + 31) / 32) * 4;
    int dst_stride = width * 2; // ARGB1555ÊØèÂÉèÁ¥†2Â≠óËäÇ
    
    // ÂàÜÈÖçÂÜÖÂ≠ò
    size_t buffer_size = dst_stride * height;
    osd_bmp->data = malloc(buffer_size);
    if (!osd_bmp->data) {
        ss_log_e("ÂàÜÈÖçÂÜÖÂ≠òÂ§±Ë¥•: %zuÂ≠óËäÇ", buffer_size);
        if (osd_bmp->palette) free(osd_bmp->palette);
        fclose(file);
        return TD_FAILURE;
    }
    
    // ÂàÜÈÖçÊèèËæπÊé©Á†ÅÂÜÖÂ≠ò
    osd_bmp->stroke_mask = calloc(width * height, sizeof(uint8_t));
    if (!osd_bmp->stroke_mask) {
        ss_log_e("ÂàÜÈÖçÊèèËæπÊé©Á†ÅÂÜÖÂ≠òÂ§±Ë¥•");
        free(osd_bmp->data);
        if (osd_bmp->palette) free(osd_bmp->palette);
        fclose(file);
        return TD_FAILURE;
    }
    
    // Ê†πÊçÆ‰ΩçÊ∑±Â∫¶Â§ÑÁêÜ‰∏çÂêåÁöÑÂÉèÁ¥†Ê†ºÂºè
    int ret = TD_SUCCESS;
    
    switch (info_header.biBitCount) {
        case 16: {
            // 16‰ΩçBMPÔºàÂèØËÉΩÊòØRGB555ÊàñRGB565Ôºâ
            uint16_t *line_buffer = malloc(src_stride);
            if (!line_buffer) {
                ss_log_e("ÂàÜÈÖçË°åÁºìÂÜ≤Âå∫Â§±Ë¥•");
                ret = TD_FAILURE;
                break;
            }
            
            // BMPÊñá‰ª∂ÂÉèÁ¥†Êï∞ÊçÆÊòØ‰ªé‰∏ãÂà∞‰∏äÂ≠òÂÇ®ÁöÑÔºåÈúÄË¶ÅÂèçÂêëËØªÂèñ
            for (int y = height - 1; y >= 0; y--) {
                if (fread(line_buffer, src_stride, 1, file) != 1) {
                    ss_log_e("ËØªÂèñÁ¨¨%dË°åÊï∞ÊçÆÂ§±Ë¥•", y);
                    ret = TD_FAILURE;
                    break;
                }
                
                // ËΩ¨Êç¢‰∏∫ARGB1555Ê†ºÂºè
                uint16_t *dst_line = (uint16_t *)osd_bmp->data + y * width;
                for (int x = 0; x < width; x++) {
                    uint16_t src_pixel = line_buffer[x];
                    
                    // ÂÅáËÆæÊ∫êÊ†ºÂºèÊòØRGB555ÔºåËΩ¨Êç¢‰∏∫ARGB1555
                    uint16_t dst_pixel = 0;
                    if (src_pixel & 0x8000) dst_pixel |= 0x8000; // Alpha
                    dst_pixel |= (src_pixel & 0x7C00);           // Red
                    dst_pixel |= (src_pixel & 0x03E0);           // Green  
                    dst_pixel |= (src_pixel & 0x001F);           // Blue
                    
                    dst_line[x] = dst_pixel;
                    
                    // Ê†áËÆ∞ÊèèËæπÂÉèÁ¥†ÔºàÁ§∫‰æãÔºöAlpha‰∏∫0ÁöÑÂÉèÁ¥†Ôºâ
                    if ((src_pixel & 0x8000) == 0) {
                        osd_bmp->stroke_mask[y * width + x] = 1;
                    }
                }
            }
            
            free(line_buffer);
            osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
            break;
        }
        
        case 24: {
            // 24‰ΩçBMPÔºàBGR888Ê†ºÂºèÔºâ
            uint8_t *line_buffer = malloc(src_stride);
            if (!line_buffer) {
                ss_log_e("ÂàÜÈÖçË°åÁºìÂÜ≤Âå∫Â§±Ë¥•");
                ret = TD_FAILURE;
                break;
            }
            
            // BMPÊñá‰ª∂ÂÉèÁ¥†Êï∞ÊçÆÊòØ‰ªé‰∏ãÂà∞‰∏äÂ≠òÂÇ®ÁöÑÔºåÈúÄË¶ÅÂèçÂêëËØªÂèñ
            for (int y = height - 1; y >= 0; y--) {
                if (fread(line_buffer, src_stride, 1, file) != 1) {
                    ss_log_e("ËØªÂèñÁ¨¨%dË°åÊï∞ÊçÆÂ§±Ë¥•", y);
                    ret = TD_FAILURE;
                    break;
                }
                
                // ËΩ¨Êç¢BGR888Âà∞ARGB1555
                uint16_t *dst_line = (uint16_t *)osd_bmp->data + y * width;
                for (int x = 0; x < width; x++) {
                    uint8_t b = line_buffer[x * 3 + 0];
                    uint8_t g = line_buffer[x * 3 + 1];
                    uint8_t r = line_buffer[x * 3 + 2];
                    
                    // ËΩ¨Êç¢‰∏∫ARGB1555Ê†ºÂºè
                    uint16_t pixel = 0x8000; // ÂÖ®‰∏çÈÄèÊòé
                    pixel |= ((r >> 3) << 10) & 0x7C00;
                    pixel |= ((g >> 3) << 5) & 0x03E0;
                    pixel |= (b >> 3) & 0x001F;
                    
                    dst_line[x] = pixel;
                }
            }
            
            free(line_buffer);
            osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
            break;
        }
        
        case 32: {
            // 32‰ΩçBMPÔºàBGRA8888Ê†ºÂºèÔºâ
            uint32_t *line_buffer = malloc(src_stride);
            if (!line_buffer) {
                ss_log_e("ÂàÜÈÖçË°åÁºìÂÜ≤Âå∫Â§±Ë¥•");
                ret = TD_FAILURE;
                break;
            }
            
            // BMPÊñá‰ª∂ÂÉèÁ¥†Êï∞ÊçÆÊòØ‰ªé‰∏ãÂà∞‰∏äÂ≠òÂÇ®ÁöÑÔºåÈúÄË¶ÅÂèçÂêëËØªÂèñ
            for (int y = height - 1; y >= 0; y--) {
                if (fread(line_buffer, src_stride, 1, file) != 1) {
                    ss_log_e("ËØªÂèñÁ¨¨%dË°åÊï∞ÊçÆÂ§±Ë¥•", y);
                    ret = TD_FAILURE;
                    break;
                }
                
                // ËΩ¨Êç¢BGRA8888Âà∞ARGB1555
                uint16_t *dst_line = (uint16_t *)osd_bmp->data + y * width;
                for (int x = 0; x < width; x++) {
                    uint32_t src_pixel = line_buffer[x];
                    uint8_t a = (src_pixel >> 24) & 0xFF;
                    uint8_t r = (src_pixel >> 16) & 0xFF;
                    uint8_t g = (src_pixel >> 8) & 0xFF;
                    uint8_t b = src_pixel & 0xFF;
                    
                    // ËΩ¨Êç¢‰∏∫ARGB1555Ê†ºÂºè
                    uint16_t dst_pixel = 0;
                    if (a > 128) dst_pixel |= 0x8000; // AlphaÈòàÂÄº
                    dst_pixel |= ((r >> 3) << 10) & 0x7C00;
                    dst_pixel |= ((g >> 3) << 5) & 0x03E0;
                    dst_pixel |= (b >> 3) & 0x001F;
                    
                    dst_line[x] = dst_pixel;
                }
            }
            
            free(line_buffer);
            osd_bmp->pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
            break;
        }
        
        default:
            ss_log_e("‰∏çÊîØÊåÅÁöÑBMP‰ΩçÊ∑±Â∫¶: %d", info_header.biBitCount);
            ret = TD_FAILURE;
            break;
    }
    
    if (ret == TD_SUCCESS) {
        // ËÆæÁΩÆot_bmppÁªìÊûÑ‰ΩìÂ±ûÊÄß
        osd_bmp->width = width;
        osd_bmp->height = height;
        osd_bmp->pitch = dst_stride;
        
        ss_log_d("BMPÂä†ËΩΩÊàêÂäü: %dx%d, Ê†ºÂºè=%d, Ê≠•Èïø=%d, Ë∞ÉËâ≤ÊùøÂ§ßÂ∞è=%d, ÊèèËæπÊé©Á†Å=%s", 
                 osd_bmp->width, osd_bmp->height, osd_bmp->pixel_format, osd_bmp->pitch, 
                 osd_bmp->palette_size, osd_bmp->stroke_mask ? "ÊòØ" : "Âê¶");
    } else {
        // Â§±Ë¥•Êó∂ÈáäÊîæÂÜÖÂ≠ò
        if (osd_bmp->data) {
            free(osd_bmp->data);
            osd_bmp->data = NULL;
        }
    }
    
    fclose(file);
    return ret;
}

/**
 * @brief ÈáäÊîæot_bmppÁªìÊûÑ‰ΩìÂÜÖÂ≠ò
 * @param osd_bmp Ë¶ÅÈáäÊîæÁöÑÁªìÊûÑ‰ΩìÊåáÈíà
 */
void bmp_free(ot_bmpp *osd_bmp) {
    if (osd_bmp) {
        if (osd_bmp->data) {
            free(osd_bmp->data);
            osd_bmp->data = NULL;
        }
        if (osd_bmp->palette) {
            free(osd_bmp->palette);
            osd_bmp->palette = NULL;
        }
        if (osd_bmp->stroke_mask) {
            free(osd_bmp->stroke_mask);
            osd_bmp->stroke_mask = NULL;
        }
        
        // ÈáçÁΩÆÊâÄÊúâÂ≠óÊÆµ
        osd_bmp->width = 0;
        osd_bmp->height = 0;
        osd_bmp->pitch = 0;
        osd_bmp->pixel_format = 0;
        osd_bmp->text_color = (SDL_Color){0, 0, 0, 0};
        osd_bmp->stroke_color = (SDL_Color){0, 0, 0, 0};
        osd_bmp->stroke_width = 0;
        osd_bmp->font_size = 0;
        osd_bmp->alignment = ALIGN_LEFT;
        osd_bmp->line_spacing = 0;
        osd_bmp->has_stroke = 0;
        
        ss_log_d("ot_bmppÁªìÊûÑ‰ΩìÂÜÖÂ≠òÂ∑≤ÂÆåÂÖ®ÈáäÊîæÂπ∂ÈáçÁΩÆ");
    }
}

/**
 * @brief Ëé∑Âèñot_bmpp‰∏≠Â≠òÂÇ®ÁöÑÊ∏≤ÊüìÂèÇÊï∞
 * @param osd_bmp ‰ΩçÂõæÁªìÊûÑ‰ΩìÊåáÈíà
 * @param text_color ËæìÂá∫ÊñáÊú¨È¢úËâ≤
 * @param stroke_color ËæìÂá∫ÊèèËæπÈ¢úËâ≤
 * @param stroke_width ËæìÂá∫ÊèèËæπÂÆΩÂ∫¶
 * @param font_size ËæìÂá∫Â≠ó‰ΩìÂ§ßÂ∞è
 * @param alignment ËæìÂá∫ÂØπÈΩêÊñπÂºè
 * @param line_spacing ËæìÂá∫Ë°åÈó¥Ë∑ù
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int bmp_get_render_params(ot_bmpp *osd_bmp, SDL_Color *text_color, SDL_Color *stroke_color, 
                         int *stroke_width, int *font_size, TextAlignment *alignment, int *line_spacing) {
    if (!osd_bmp) {
        ss_log_e("‰ΩçÂõæÁªìÊûÑ‰ΩìÊåáÈíà‰∏∫Á©∫");
        return TD_FAILURE;
    }
    
    // Â§çÂà∂Ê∏≤ÊüìÂèÇÊï∞Âà∞ËæìÂá∫ÂèÇÊï∞
    if (text_color) *text_color = osd_bmp->text_color;
    if (stroke_color) *stroke_color = osd_bmp->stroke_color;
    if (stroke_width) *stroke_width = osd_bmp->stroke_width;
    if (font_size) *font_size = osd_bmp->font_size;
    if (alignment) *alignment = osd_bmp->alignment;
    if (line_spacing) *line_spacing = osd_bmp->line_spacing;
    
    ss_log_d("Ëé∑ÂèñÊ∏≤ÊüìÂèÇÊï∞: ÊñáÂ≠óÈ¢úËâ≤(%d,%d,%d,%d), Â≠óÂè∑=%d, ÂØπÈΩê=%d, ÊèèËæπ=%s", 
            osd_bmp->text_color.r, osd_bmp->text_color.g, osd_bmp->text_color.b, osd_bmp->text_color.a,
            osd_bmp->font_size, osd_bmp->alignment, osd_bmp->has_stroke ? "ÊòØ" : "Âê¶");
    
    return TD_SUCCESS;
}



/**
 * @brief Â∞Üot_bmppÊï∞ÊçÆ‰øùÂ≠ò‰∏∫BMPÊñá‰ª∂
 * @param osd_bmp ÂåÖÂê´‰ΩçÂõæÊï∞ÊçÆÁöÑÁªìÊûÑ‰ΩìÊåáÈíà
 * @param filename Ë¶Å‰øùÂ≠òÁöÑÊñá‰ª∂Âêç
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int save_bmp_file(ot_bmpp *osd_bmp, const char *filename) {
    pthread_mutex_lock(&g_mux);
    if (!osd_bmp || !osd_bmp->data) {
        ss_log_e("Êó†ÊïàÁöÑ‰ΩçÂõæÊï∞ÊçÆ");
        pthread_mutex_unlock(&g_mux);
        return TD_FAILURE;
    }
    
    // Â¶ÇÊûú‰∏çÊòØ16‰ΩçÊ†ºÂºèÔºåÂÖàËΩ¨Êç¢‰∏∫16‰Ωç
    ot_bmpp temp_bmp;
    memset(&temp_bmp, 0, sizeof(ot_bmpp));
    
    if (osd_bmp->pixel_format != OT_PIXEL_FORMAT_ARGB_1555) {
        ss_log_d("Èùû16‰ΩçÊ†ºÂºèÔºåÂ∞ùËØïËΩ¨Êç¢‰∏∫16‰ΩçARGB1555");
        
        // ÂàõÂª∫‰∏¥Êó∂Ë°®Èù¢Áî®‰∫éËΩ¨Êç¢
        Uint32 rmask32 = 0x00FF0000, gmask32 = 0x0000FF00, bmask32 = 0x000000FF, amask32 = 0xFF000000;
        SDL_Surface *src_surface = SDL_CreateRGBSurfaceFrom(
            osd_bmp->data, osd_bmp->width, osd_bmp->height, 32, osd_bmp->pitch,
            rmask32, gmask32, bmask32, amask32
        );
        
        if (!src_surface) {
            ss_log_e("ÂàõÂª∫Ê∫êË°®Èù¢Â§±Ë¥•: %s", SDL_GetError());
            pthread_mutex_unlock(&g_mux);
            return TD_FAILURE;
        }
        
        // ÂàõÂª∫ÁõÆÊ†á16‰ΩçË°®Èù¢
        Uint32 rmask16 = 0x7C00, gmask16 = 0x03E0, bmask16 = 0x001F, amask16 = 0x8000;
        SDL_Surface *dest_surface = SDL_CreateRGBSurface(
            0, osd_bmp->width, osd_bmp->height, 16,
            rmask16, gmask16, bmask16, amask16
        );
        
        if (!dest_surface) {
            ss_log_e("ÂàõÂª∫ÁõÆÊ†áË°®Èù¢Â§±Ë¥•: %s", SDL_GetError());
            SDL_FreeSurface(src_surface);
            pthread_mutex_unlock(&g_mux);
            return TD_FAILURE;
        }
        
        // ËΩ¨Êç¢Ê†ºÂºè
        if (convert_32bit_to_16bit(src_surface, dest_surface) != TD_SUCCESS) {
            ss_log_e("Ê†ºÂºèËΩ¨Êç¢Â§±Ë¥•");
            SDL_FreeSurface(src_surface);
            SDL_FreeSurface(dest_surface);
            pthread_mutex_unlock(&g_mux);
            return TD_FAILURE;
        }
        
        // Â°´ÂÖÖ‰∏¥Êó∂bmpÁªìÊûÑ
        temp_bmp.width = osd_bmp->width;
        temp_bmp.height = osd_bmp->height;
        temp_bmp.pixel_format = OT_PIXEL_FORMAT_ARGB_1555;
        temp_bmp.pitch = dest_surface->pitch;
        
        size_t buffer_size = dest_surface->pitch * dest_surface->h;
        temp_bmp.data = malloc(buffer_size);
        if (!temp_bmp.data) {
            ss_log_e("ÂàÜÈÖçÂÜÖÂ≠òÂ§±Ë¥•");
            SDL_FreeSurface(src_surface);
            SDL_FreeSurface(dest_surface);
            pthread_mutex_unlock(&g_mux);
            return TD_FAILURE;
        }
        
        memcpy(temp_bmp.data, dest_surface->pixels, buffer_size);
        
        // Â§çÂà∂Ê∏≤ÊüìÂèÇÊï∞
        temp_bmp.text_color = osd_bmp->text_color;
        temp_bmp.stroke_color = osd_bmp->stroke_color;
        temp_bmp.stroke_width = osd_bmp->stroke_width;
        temp_bmp.font_size = osd_bmp->font_size;
        temp_bmp.alignment = osd_bmp->alignment;
        temp_bmp.line_spacing = osd_bmp->line_spacing;
        temp_bmp.has_stroke = osd_bmp->has_stroke;
        
        SDL_FreeSurface(src_surface);
        SDL_FreeSurface(dest_surface);
        
        // ‰ΩøÁî®‰∏¥Êó∂bmp
        osd_bmp = &temp_bmp;
    }
    
    FILE *file = fopen(filename, "wb");
    if (!file) {
        ss_log_e("Êó†Ê≥ïÂàõÂª∫Êñá‰ª∂: %s", filename);
        if (osd_bmp == &temp_bmp) {
            free(temp_bmp.data);
        }
        pthread_mutex_unlock(&g_mux);
        return TD_FAILURE;
    }
    
    // ÂàõÂª∫BMPÊñá‰ª∂Â§¥Âíå‰ø°ÊÅØÂ§¥
    BMPFileHeader file_header = {0};
    BMPInfoHeader info_header = {0};
    
    // ËÆ°ÁÆóÊâ©Â±ïÊï∞ÊçÆÂ§ßÂ∞èÔºàÊ∏≤ÊüìÂèÇÊï∞Ôºâ
    size_t extended_data_size = 0;
    if (osd_bmp->has_stroke || osd_bmp->font_size > 0) {
        extended_data_size = sizeof(SDL_Color) * 2 + sizeof(int) * 5;
    }
    
    // ËÆæÁΩÆÊñá‰ª∂Â§¥
    file_header.bfType = 0x4D42; // "BM"
    file_header.bfOffBits = sizeof(BMPFileHeader) + sizeof(BMPInfoHeader) + extended_data_size;
    file_header.bfSize = file_header.bfOffBits + osd_bmp->height * osd_bmp->pitch;
    
    // ËÆæÁΩÆ‰ø°ÊÅØÂ§¥
    info_header.biSize = sizeof(BMPInfoHeader);
    info_header.biWidth = osd_bmp->width;
    info_header.biHeight = osd_bmp->height;
    info_header.biPlanes = 1;
    info_header.biBitCount = 16; // 16‰Ωç
    info_header.biCompression = 0; // ‰∏çÂéãÁº©
    info_header.biSizeImage = osd_bmp->height * osd_bmp->pitch;
    
    // ÂÜôÂÖ•Êñá‰ª∂Â§¥Âíå‰ø°ÊÅØÂ§¥
    fwrite(&file_header, sizeof(BMPFileHeader), 1, file);
    fwrite(&info_header, sizeof(BMPInfoHeader), 1, file);
    
    // ÂÜôÂÖ•Êâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
    if (extended_data_size > 0) {
        fwrite(&osd_bmp->text_color, sizeof(SDL_Color), 1, file);
        fwrite(&osd_bmp->stroke_color, sizeof(SDL_Color), 1, file);
        fwrite(&osd_bmp->stroke_width, sizeof(int), 1, file);
        fwrite(&osd_bmp->font_size, sizeof(int), 1, file);
        fwrite(&osd_bmp->alignment, sizeof(int), 1, file);
        fwrite(&osd_bmp->line_spacing, sizeof(int), 1, file);
        fwrite(&osd_bmp->has_stroke, sizeof(int), 1, file);
        
        ss_log_d("Êâ©Â±ïÊ∏≤ÊüìÂèÇÊï∞Â∑≤ÂÜôÂÖ•BMPÊñá‰ª∂: Â≠óÂè∑=%d, ÊèèËæπ=%s", 
                osd_bmp->font_size, osd_bmp->has_stroke ? "ÊòØ" : "Âê¶");
    }
    
    // ÂÜôÂÖ•ÂÉèÁ¥†Êï∞ÊçÆÔºàÊ≥®ÊÑèBMPÊòØ‰ªé‰∏ãÂà∞‰∏äÂ≠òÂÇ®ÁöÑÔºâ
    for (int y = osd_bmp->height - 1; y >= 0; y--) {
        uint16_t *line = (uint16_t *)osd_bmp->data + y * osd_bmp->width;
        fwrite(line, osd_bmp->pitch, 1, file);
    }
    
    fclose(file);
    
    // Ê∏ÖÁêÜ‰∏¥Êó∂Êï∞ÊçÆ
    if (osd_bmp == &temp_bmp) {
        free(temp_bmp.data);
    }
    
    ss_log_d("BMPÊñá‰ª∂‰øùÂ≠òÊàêÂäü: %s", filename);
    pthread_mutex_unlock(&g_mux);
    return TD_SUCCESS;
}

/**
 * @brief ÂûÇÁõ¥ÊãºÊé•Â§ö‰∏™BMPÊñá‰ª∂
 * @param filenames BMPÊñá‰ª∂Ë∑ØÂæÑÊï∞ÁªÑ
 * @param count Êñá‰ª∂Êï∞Èáè
 * @param alignment ÂØπÈΩêÊñπÂºèÔºàALIGN_LEFT/ALIGN_CENTER/ALIGN_RIGHTÔºâ
 * @param output_filename ËæìÂá∫Êñá‰ª∂Ë∑ØÂæÑ
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int bmp_concatenate_vertically(const char **filenames, int count, TextAlignment alignment, const char *output_filename) {
    if (!filenames || count <= 0 || !output_filename) {
        ss_log_e("ÂèÇÊï∞ÈîôËØØ: Êñá‰ª∂ÂêçÊï∞ÁªÑ„ÄÅÊï∞ÈáèÊàñËæìÂá∫Êñá‰ª∂Âêç‰∏∫Á©∫");
        return TD_FAILURE;
    }

    // Âä†ËΩΩÊâÄÊúâ BMP Êñá‰ª∂
    ot_bmpp *bmps = malloc(count * sizeof(ot_bmpp));
    if (!bmps) {
        ss_log_e("ÂàÜÈÖçÂÜÖÂ≠òÂ§±Ë¥•");
        return TD_FAILURE;
    }

    int max_width = 0;
    int total_height = 0;
    for (int i = 0; i < count; i++) {
        memset(&bmps[i], 0, sizeof(ot_bmpp));
        if (bmp_load_file(filenames[i], &bmps[i]) != TD_SUCCESS) {
            ss_log_e("Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: %s", filenames[i]);
            // Ê∏ÖÁêÜÂ∑≤Âä†ËΩΩÁöÑ BMP
            for (int j = 0; j < i; j++) bmp_free(&bmps[j]);
            free(bmps);
            return TD_FAILURE;
        }
        if (bmps[i].width > max_width) max_width = bmps[i].width;
        total_height += bmps[i].height;
    }

    // ÂàõÂª∫ËæìÂá∫ BMP
    ot_bmpp output_bmp = {
        .width = max_width,
        .height = total_height,
        .pixel_format = OT_PIXEL_FORMAT_ARGB_1555,
        .pitch = max_width * 2 // 16 ‰ΩçËâ≤Ê∑±
    };
    output_bmp.data = malloc(output_bmp.pitch * total_height);
    if (!output_bmp.data) {
        for (int i = 0; i < count; i++) bmp_free(&bmps[i]);
        free(bmps);
        return TD_FAILURE;
    }
    memset(output_bmp.data, 0, output_bmp.pitch * total_height); // ÂàùÂßãÂåñÂÉèÁ¥†Êï∞ÊçÆ

    // ÊãºÊé•ÂÉèÁ¥†Êï∞ÊçÆ
    uint16_t *dst = (uint16_t *)output_bmp.data;
    int current_y = 0;
    for (int i = 0; i < count; i++) {
        int offset_x = (alignment == ALIGN_CENTER) ? (max_width - bmps[i].width) / 2 :
                      (alignment == ALIGN_RIGHT) ? max_width - bmps[i].width : 0;

        uint16_t *src = (uint16_t *)bmps[i].data;
        for (int y = 0; y < bmps[i].height; y++) {
            for (int x = 0; x < bmps[i].width; x++) {
                dst[(current_y + y) * max_width + offset_x + x] = src[y * bmps[i].width + x];
            }
        }
        current_y += bmps[i].height;
    }

    // ‰øùÂ≠òËæìÂá∫Êñá‰ª∂
    int ret = save_bmp_file(&output_bmp, output_filename);

    // Ê∏ÖÁêÜÂÜÖÂ≠ò
    bmp_free(&output_bmp);
    for (int i = 0; i < count; i++) bmp_free(&bmps[i]);
    free(bmps);

    return ret;
}


/**
 * @brief ÂûÇÁõ¥ÊãºÊé•Â§ö‰∏™BMPÊñá‰ª∂Âπ∂ÊîØÊåÅ‰∫åÊ¨°Ê∏≤Êüì
 * @param filenames BMPÊñá‰ª∂Ë∑ØÂæÑÊï∞ÁªÑ
 * @param count Êñá‰ª∂Êï∞Èáè
 * @param alignment ÂØπÈΩêÊñπÂºèÔºàALIGN_LEFT/ALIGN_CENTER/ALIGN_RIGHTÔºâ
 * @param output_filename ËæìÂá∫Êñá‰ª∂Ë∑ØÂæÑ
 * @param out_merged_bmp ÂêàÂπ∂ÂêéÁöÑBMPÁªìÊûÑ‰ΩìÊåáÈíà
 * @return ÊàêÂäüËøîÂõûTD_SUCCESSÔºåÂ§±Ë¥•ËøîÂõûTD_FAILURE
 */
int bmp_concatenate_with_rendering(const char **filenames, int count, TextAlignment alignment, const char *output_filename, ot_bmpp **out_merged_bmp) {
    if (!filenames || count <= 0 || !output_filename) {
        ss_log_e("ÂèÇÊï∞ÈîôËØØ: Êñá‰ª∂ÂêçÊï∞ÁªÑ„ÄÅÊï∞ÈáèÊàñËæìÂá∫Êñá‰ª∂Âêç‰∏∫Á©∫");
        return TD_FAILURE;
    }

    // Âä†ËΩΩÊâÄÊúâ BMP Êñá‰ª∂
    ot_bmpp *bmps = malloc(count * sizeof(ot_bmpp));
    if (!bmps) {
        ss_log_e("ÂàÜÈÖçÂÜÖÂ≠òÂ§±Ë¥•");
        return TD_FAILURE;
    }

    int max_width = 0;
    int total_height = 0;
    for (int i = 0; i < count; i++) {
        memset(&bmps[i], 0, sizeof(ot_bmpp));
        if (bmp_load_file(filenames[i], &bmps[i]) != TD_SUCCESS) {
            ss_log_e("Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: %s", filenames[i]);
            // Ê∏ÖÁêÜÂ∑≤Âä†ËΩΩÁöÑ BMP
            for (int j = 0; j < i; j++) bmp_free(&bmps[j]);
            free(bmps);
            return TD_FAILURE;
        }
        if (bmps[i].width > max_width) max_width = bmps[i].width;
        total_height += bmps[i].height;
    }

    // ÂàõÂª∫ÁõÆÊ†á BMP
    ot_bmpp merged_bmp = {
        .width = max_width,
        .height = total_height,
        .pixel_format = OT_PIXEL_FORMAT_ARGB_1555,
        .pitch = max_width * 2 // 16 ‰ΩçËâ≤Ê∑±
    };
    merged_bmp.data = malloc(merged_bmp.pitch * total_height);
    if (!merged_bmp.data) {
        for (int i = 0; i < count; i++) bmp_free(&bmps[i]);
        free(bmps);
        return TD_FAILURE;
    }
    memset(merged_bmp.data, 0, merged_bmp.pitch * total_height); // ÂàùÂßãÂåñÂÉèÁ¥†Êï∞ÊçÆ

    // ÊãºÊé•ÂÉèÁ¥†Êï∞ÊçÆ
    uint16_t *dst = (uint16_t *)merged_bmp.data;
    int current_y = 0;
    for (int i = 0; i < count; i++) {
        int offset_x = (alignment == ALIGN_CENTER) ? (max_width - bmps[i].width) / 2 :
                      (alignment == ALIGN_RIGHT) ? max_width - bmps[i].width : 0;

        uint16_t *src = (uint16_t *)bmps[i].data;
        for (int y = 0; y < bmps[i].height; y++) {
            for (int x = 0; x < bmps[i].width; x++) {
                dst[(current_y + y) * max_width + offset_x + x] = src[y * bmps[i].width + x];
            }
        }
        current_y += bmps[i].height;
    }

    // ‰øùÂ≠òËæìÂá∫Êñá‰ª∂
    int ret = save_bmp_file(&merged_bmp, output_filename);

    // ËøîÂõûÊãºÊé•ÂêéÁöÑ BMP ÂØπË±°
    if (out_merged_bmp && ret == TD_SUCCESS) {
        *out_merged_bmp = malloc(sizeof(ot_bmpp));
        if (!*out_merged_bmp) {
            ret = TD_FAILURE;
            free(merged_bmp.data);
        } else {
            memcpy(*out_merged_bmp, &merged_bmp, sizeof(ot_bmpp));
        }
    } else {
        // Â¶ÇÊûú‰∏çÈúÄË¶ÅËøîÂõûÂØπË±°ÊàñÂ§±Ë¥•ÔºåÈáäÊîæÂÜÖÂ≠ò
        free(merged_bmp.data);
    }

    // Ê∏ÖÁêÜÂä†ËΩΩÁöÑBMPÊñá‰ª∂ÂÜÖÂ≠ò
    for (int i = 0; i < count; i++) bmp_free(&bmps[i]);
    free(bmps);

    return ret;
}




static int verify_font_state(TTF_Font *font) {
    int style = TTF_GetFontStyle(font);
    int outline = TTF_GetFontOutline(font);
    
    if (style != TTF_STYLE_NORMAL || outline != 0) {
        ss_log_e("Â≠ó‰ΩìÁä∂ÊÄÅÂºÇÂ∏∏: style=%d, outline=%d", style, outline);
        
        // Âº∫Âà∂‰øÆÂ§ç
        TTF_SetFontStyle(font, TTF_STYLE_NORMAL);
        TTF_SetFontOutline(font, 0);
        
        return TD_FAILURE;
    }
    return TD_SUCCESS;
}

// Âú®mainÂáΩÊï∞‰∏≠Ê∑ªÂä†ÊµãËØï‰ª£Á†Å
void test_font_style_consistency() {
    printf("=== ÊµãËØïÂ≠ó‰ΩìÊ†∑Âºè‰∏ÄËá¥ÊÄß ===\n");
    
    for (int size = 12; size <= 36; size += 6) {
        ot_bmpp test_bmp;
        SDL_Color test_color = {255, 0, 0, 255};
        
        // ÊµãËØïÊ∑∑ÂêàÊñáÊú¨
        char *mixed_text = "aÊµãËØïText123\nbbÊ∑∑ÂêàÊñáÊú¨\nccc‰∏≠ÊñáEnglish";
        
        for (int i = 0; i < 3; i++) {
            char filename[100];
            sprintf(filename, "consistency_test_%d_%d.bmp", size, i);
            
            if (ttf_get_multiline_bmp(&test_bmp, mixed_text, test_color, size, 
                                     NULL, 0, ALIGN_LEFT, 10) == TD_SUCCESS) {
                if (test_bmp.data) {
                    save_bmp_file(&test_bmp, filename);

                    free(test_bmp.data);
                    printf("ÁîüÊàê: %s (Â≠óÂè∑: %dpt, ËΩÆÊ¨°: %d)\n", filename, size, i);
                }
            }
        }
    }
}

void test_concatenate_font_style_bmps() {
    printf("=== ÊµãËØïÂ≠ó‰ΩìÊ†∑ÂºèBMPÊãºÊé• ===\n");

    // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑÊñá‰ª∂Âêç
    const char *filenames[15]; // 5ÁßçÂ≠óÂè∑ * 3ËΩÆÊ¨° = 15‰∏™Êñá‰ª∂
    int count = 0;

    // ÂÖàÁ°Æ‰øùÊâÄÊúâÊµãËØïÊñá‰ª∂ÈÉΩÂ≠òÂú®
    for (int size = 12; size <= 36; size += 6) {
        for (int i = 0; i < 3; i++) {
            char *filename = malloc(100);
            sprintf(filename, "consistency_test_%d_%d.bmp", size, i);
            
            // Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÁîüÊàê
            if (access(filename, F_OK) != 0) {
                printf("ÁîüÊàêÁº∫Â§±ÁöÑÊµãËØïÊñá‰ª∂: %s\n", filename);
                test_single_case("aÊµãËØïText123\nbbÊ∑∑ÂêàÊñáÊú¨\nccc‰∏≠ÊñáEnglish", size, ALIGN_LEFT, 10, filename);
            }
            
            filenames[count++] = filename;
        }
    }

    // Ë∞ÉÁî®ÊãºÊé•ÂáΩÊï∞
    ot_bmpp *merged_bmp = NULL;
    if (bmp_concatenate_with_rendering(filenames, count, ALIGN_CENTER, "concatenated_font_style.bmp", &merged_bmp) == TD_SUCCESS) {
        printf("ÊãºÊé•ÊàêÂäü: concatenated_font_style.bmp\n");
        if (merged_bmp) {
            bmp_free(merged_bmp);
            merged_bmp = NULL;
        }
    } else {
        printf("ÊãºÊé•Â§±Ë¥•\n");
    }

    // ÈáäÊîæÊñá‰ª∂ÂêçÂÜÖÂ≠ò
    for (int i = 0; i < count; i++) {
        free((void *)filenames[i]);
    }
}

void test_minimal_case() {
    printf("=== ÊúÄÂ∞èÂåñÊµãËØï ===\n");
    
    // ÊµãËØï1: Á∫Ø‰∏≠Êñá
    test_single_case("Á∫Ø‰∏≠ÊñáÊµãËØï", 24, ALIGN_LEFT, 0, "chinese_only.bmp");
    
    // ÊµãËØï2: Á∫ØËã±Êñá
    test_single_case("English only", 24, ALIGN_LEFT, 0, "english_only.bmp");
    
    // ÊµãËØï3: ‰∏≠Ëã±Ê∑∑Âêà
    test_single_case("a‰∏≠Ëã±Ê∑∑ÂêàText", 24, ALIGN_LEFT, 0, "mixed.bmp");
    
    // ÊµãËØï4: Â§öÊ¨°Ê∏≤ÊüìÂêå‰∏ÄÊñáÊú¨
    for (int i = 0; i < 5; i++) {
        char filename[100];
        sprintf(filename, "repeat_%d.bmp", i);
        test_single_case("aÈáçÂ§çÊµãËØï", 24, ALIGN_LEFT, 0, filename);
    }
}

void test_single_case(const char *text, int size, TextAlignment align, int spacing, const char *filename) {
    ot_bmpp bmp;
    SDL_Color color = {255, 0, 0, 255};
    
    if (ttf_get_multiline_bmp(&bmp, text, color, size, NULL, 0, align, spacing) == TD_SUCCESS) {
        if (bmp.data) {
            save_bmp_file(&bmp, filename);
            free(bmp.data);
            bmp.data = NULL;
            printf("ÁîüÊàê: %s\n", filename);
        }
    }
}


void test_bmp_concatenation() {
    printf("=== ÊµãËØïBMPÂêàÊàêÂäüËÉΩ ===\n");

    // 1. ÂàõÂª∫ÊµãËØïBMPÊñá‰ª∂
    const char *filenames[] = {
        "test1.bmp",
        "test2.bmp",
        "test3.bmp"
    };
    int count = sizeof(filenames) / sizeof(filenames[0]);

    // ÁîüÊàêÊµãËØïBMPÊñá‰ª∂
    for (int i = 0; i < count; i++) {
        ot_bmpp bmp;
        SDL_Color color = {255, 0, 0, 255}; // Á∫¢Ëâ≤
        char text[50];
        sprintf(text, "ÊµãËØïÊñáÊú¨ %d", i + 1);

        if (ttf_get_bmp(&bmp, text, color, 24, NULL, 0) == TD_SUCCESS) {
            save_bmp_file(&bmp, filenames[i]);
            bmp_free(&bmp);
            printf("ÁîüÊàêÊµãËØïÊñá‰ª∂: %s\n", filenames[i]);
            
        }
    }

    // 2. ÊµãËØïÂûÇÁõ¥ÊãºÊé•ÔºàÁ∫ØÊãºÊé•Ôºâ
    if (bmp_concatenate_vertically(filenames, count, ALIGN_CENTER, "concatenated_vertical.bmp") == TD_SUCCESS) {
        printf("ÂûÇÁõ¥ÊãºÊé•ÊàêÂäü: concatenated_vertical.bmp\n");
    } else {
        printf("ÂûÇÁõ¥ÊãºÊé•Â§±Ë¥•\n");
    }

    // 3. ÊµãËØïÂ∏¶Ê∏≤ÊüìÁöÑÂûÇÁõ¥ÊãºÊé•
    ot_bmpp *merged_bmp = NULL;
    if (bmp_concatenate_with_rendering(filenames, count, ALIGN_CENTER, "concatenated_with_rendering.bmp", &merged_bmp) == TD_SUCCESS) {
        printf("Â∏¶Ê∏≤ÊüìÁöÑÂûÇÁõ¥ÊãºÊé•ÊàêÂäü: concatenated_with_rendering.bmp\n");
        if (merged_bmp) {
            bmp_free(merged_bmp);
            merged_bmp = NULL;
        }
    } else {
        printf("Â∏¶Ê∏≤ÊüìÁöÑÂûÇÁõ¥ÊãºÊé•Â§±Ë¥•\n");
    }
}

int main__osd(int argc, char **argv) {
    if (SDL_Init(SDL_INIT_VIDEO) < 0) {
        printf("SDLÂàùÂßãÂåñÂ§±Ë¥•: %s\n", SDL_GetError());
        return 1;
    }
    
    ot_bmpp osd_bmp;
    SDL_Color text_color = {255, 0, 0, 255}; // Á∫¢Ëâ≤ÊñáÂ≠ó
    SDL_Color stroke_color = {255, 255, 0, 255}; // ÈªÑËâ≤ÊèèËæπ
    
    printf("ÂºÄÂßãÂÖ®Èù¢ÊµãËØïÊñáÂ≠óÊ∏≤ÊüìÂäüËÉΩ...\n");
    
    // ====================
    // 1. ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂçïË°åÊñáÊú¨ÔºàÊó†ÊèèËæπÔºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂçïË°åÊñáÊú¨ÔºàÊó†ÊèèËæπÔºâ ===\n");
    for (int size = 12; size <= 36; size += 6) {
        char filename[50];
        sprintf(filename, "single_no_stroke_%d.bmp", size);
        
        if (ttf_get_bmp(&osd_bmp, "aÂçïË°åÊµãËØïÊñáÊú¨", text_color, size, NULL, 0) == TD_SUCCESS) {
            if (osd_bmp.data) {
                save_bmp_file(&osd_bmp, filename);
                
                free(osd_bmp.data);
                printf("ÁîüÊàê: %s (Â≠óÂè∑: %dpt)\n", filename, size);
            }
        }
    }
    
    // ====================
    // 2. ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂçïË°åÊñáÊú¨ÔºàÂ∏¶ÊèèËæπÔºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂçïË°åÊñáÊú¨ÔºàÂ∏¶ÊèèËæπÔºâ ===\n");
    for (int size = 12; size <= 36; size += 6) {
        char filename[50];
        sprintf(filename, "single_with_stroke_%d.bmp", size);
        
        if (ttf_get_bmp(&osd_bmp, "1ÂçïË°åÊèèËæπÊµãËØï", text_color, size, &stroke_color, 2) == TD_SUCCESS) {
            if (osd_bmp.data) {
                save_bmp_file(&osd_bmp, filename);
                free(osd_bmp.data);
                printf("ÁîüÊàê: %s (Â≠óÂè∑: %dpt)\n", filename, size);
            }
        }
    }

    
    // ====================
    // 3. ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂ§öË°åÊñáÊú¨ÔºàÊó†ÊèèËæπÔºå‰∏çÂêåÂØπÈΩêÔºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂ§öË°åÊñáÊú¨ÔºàÊó†ÊèèËæπÔºâ ===\n");
    char *multiline_text = "aÁ¨¨‰∏ÄË°åÊñáÊú¨\nbbÁ¨¨‰∫åË°åÂÜÖÂÆπ\ncccÁ¨¨‰∏âË°åÊµãËØï";
    
    // ÊµãËØï‰∏çÂêåÂØπÈΩêÊñπÂºè
    TextAlignment alignments[] = {ALIGN_LEFT, ALIGN_CENTER, ALIGN_RIGHT};
    const char *align_names[] = {"left", "center", "right"};
    
    for (int size = 12; size <= 36; size += 6) {
        for (int i = 0; i < 3; i++) {
            char filename[100];
            sprintf(filename, "multiline_no_stroke_%s_%d.bmp", align_names[i], size);
            
            if (ttf_get_multiline_bmp(&osd_bmp, multiline_text, text_color, size, 
                                     NULL, 0, alignments[i], 10) == TD_SUCCESS) {
                if (osd_bmp.data) {
                    save_bmp_file(&osd_bmp, filename);
                    free(osd_bmp.data);
                    printf("ÁîüÊàê: %s (Â≠óÂè∑: %dpt, ÂØπÈΩê: %s)\n", filename, size, align_names[i]);
                }
            }
        }
    }
    
    // ====================
    // 4. ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂ§öË°åÊñáÊú¨ÔºàÂ∏¶ÊèèËæπÔºå‰∏çÂêåÂØπÈΩêÔºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåÂ§ßÂ∞èÁöÑÂ§öË°åÊñáÊú¨ÔºàÂ∏¶ÊèèËæπÔºâ ===\n");
    for (int size = 12; size <= 36; size += 6) {
        for (int i = 0; i < 3; i++) {
            char filename[100];
            sprintf(filename, "multiline_with_stroke_%s_%d.bmp", align_names[i], size);
            
            if (ttf_get_multiline_bmp(&osd_bmp, multiline_text, text_color, size, 
                                     &stroke_color, 2, alignments[i], 10) == TD_SUCCESS) {
                if (osd_bmp.data) {
                    save_bmp_file(&osd_bmp, filename);
                    free(osd_bmp.data);
                    printf("ÁîüÊàê: %s (Â≠óÂè∑: %dpt, ÂØπÈΩê: %s)\n", filename, size, align_names[i]);
                }
            }
        }
    }
    
    // ====================
    // 5. ÊµãËØï‰∏çÂêåË°åÈó¥Ë∑ùÔºàÂ§öË°åÊñáÊú¨Ôºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåË°åÈó¥Ë∑ùÔºàÂ§öË°åÊñáÊú¨Ôºâ ===\n");
    int spacings[] = {5, 10, 15, 20};
    
    for (int i = 0; i < 4; i++) {
        char filename[100];
        sprintf(filename, "multiline_spacing_%d.bmp", spacings[i]);
        
        if (ttf_get_multiline_bmp(&osd_bmp, multiline_text, text_color, 24, 
                                 NULL, 0, ALIGN_CENTER, spacings[i]) == TD_SUCCESS) {
            if (osd_bmp.data) {
                save_bmp_file(&osd_bmp, filename);
                free(osd_bmp.data);
                printf("ÁîüÊàê: %s (Ë°åÈó¥Ë∑ù: %dpx)\n", filename, spacings[i]);
            }
        }
    }
    
    // ====================
    // 6. ÊµãËØï‰∏çÂêåÊèèËæπÂÆΩÂ∫¶ÔºàÂ§öË°åÊñáÊú¨Ôºâ
    // ====================
    printf("\n=== ÊµãËØï‰∏çÂêåÊèèËæπÂÆΩÂ∫¶ÔºàÂ§öË°åÊñáÊú¨Ôºâ ===\n");
    int stroke_widths[] = {1, 2, 3, 4};
    
    for (int i = 0; i < 4; i++) {
        char filename[100];
        sprintf(filename, "multiline_stroke_width_%d.bmp", stroke_widths[i]);
        
        if (ttf_get_multiline_bmp(&osd_bmp, multiline_text, text_color, 24, 
                                 &stroke_color, stroke_widths[i], ALIGN_CENTER, 10) == TD_SUCCESS) {
            if (osd_bmp.data) {
                save_bmp_file(&osd_bmp, filename);
                free(osd_bmp.data);
                printf("ÁîüÊàê: %s (ÊèèËæπÂÆΩÂ∫¶: %dpx)\n", filename, stroke_widths[i]);
            }
        }
    }
    
    // ====================
    // 7. ÊµãËØïÈïøÊñáÊú¨ÔºàÂ§öË°åÔºâ
    // ====================
    printf("\n=== ÊµãËØïÈïøÊñáÊú¨ÔºàÂ§öË°åÔºâ ===\n");
    char *long_text = "ËøôÊòØ‰∏Ä‰∏™ËæÉÈïøÁöÑÂ§öË°åÊñáÊú¨ÊµãËØïÔºåÁî®‰∫éÈ™åËØÅÊñáÊú¨Ê∏≤ÊüìÁ≥ªÁªüÂ§ÑÁêÜÂ§öË°åÊñáÊú¨ÁöÑËÉΩÂäõ„ÄÇ\n"
                     "ÊñáÊú¨Â∫îËØ•Ëá™Âä®Êç¢Ë°åÂπ∂‰øùÊåÅÊ≠£Á°ÆÁöÑÂØπÈΩêÊñπÂºè„ÄÇ\n"
                     "ËøôÊòØÁ¨¨‰∏âË°åÊñáÊú¨ÔºåÁî®‰∫éÊµãËØïË°åÈó¥Ë∑ùÂíåÊèèËæπÊïàÊûú„ÄÇ";

    const char* long_text_filenames[3] = {};

    // ÊµãËØï‰∏çÂêåÂØπÈΩêÊñπÂºèÁöÑÈïøÊñáÊú¨
    for (int i = 0; i < 3; i++) {
        char filename[100];
        sprintf(filename, "long_text_%s.bmp", align_names[i]);
        long_text_filenames[i] = filename;
        
        if (ttf_get_multiline_bmp(&osd_bmp, long_text, text_color, 18, 
                                 &stroke_color, 2, alignments[i], 8) == TD_SUCCESS) {
            if (osd_bmp.data) {
                save_bmp_file(&osd_bmp, filename);
                free(osd_bmp.data);
                printf("ÁîüÊàê: %s (ÂØπÈΩê: %s)\n", filename, align_names[i]);
            }
        }
    }
    bmp_concatenate_vertically(long_text_filenames, 3, ALIGN_CENTER, "long_text_concatenated.bmp");

    ot_bmpp *merged_bmp = NULL;
    if (bmp_concatenate_with_rendering(long_text_filenames, 3, ALIGN_CENTER, "long_text_concatenated_with_rendering.bmp", &merged_bmp) == TD_SUCCESS) {
        printf("Â∏¶Ê∏≤ÊüìÁöÑÂûÇÁõ¥ÊãºÊé•ÊàêÂäü: long_text_concatenated_with_rendering.bmp\n");
        if (merged_bmp) {
            bmp_free(merged_bmp);
            merged_bmp = NULL;
        }
    } else {
        printf("Â∏¶Ê∏≤ÊüìÁöÑÂûÇÁõ¥ÊãºÊé•Â§±Ë¥•\n");
    }


    test_concatenate_font_style_bmps();

    test_font_style_consistency();
    test_minimal_case();

    test_concatenate_font_style_bmps();
    
    // ÊµãËØïBMPÂêàÊàêÂäüËÉΩ
    //test_bmp_concatenation();
    
    // ====================
    // 8. ÊµãËØïÊ∏≤ÊüìÂèÇÊï∞Â≠òÂÇ®ÂíåËØªÂèñ
    // ====================
    printf("\n=== ÊµãËØïÊ∏≤ÊüìÂèÇÊï∞Â≠òÂÇ®ÂíåËØªÂèñ ===\n");
    
    // ÂàõÂª∫‰∏Ä‰∏™Â∏¶ÊèèËæπÁöÑ‰ΩçÂõæ
    ot_bmpp test_bmp;
    if (ttf_get_bmp(&test_bmp, "ÂèÇÊï∞ÊµãËØï", text_color, 24, &stroke_color, 2) == TD_SUCCESS) {
        // ‰øùÂ≠òÂà∞Êñá‰ª∂
        save_bmp_file(&test_bmp, "render_params_test.bmp");
        
        // ËØªÂèñÊ∏≤ÊüìÂèÇÊï∞
        SDL_Color read_text_color, read_stroke_color;
        int read_stroke_width, read_font_size, read_line_spacing;
        TextAlignment read_alignment;
        
        if (bmp_get_render_params(&test_bmp, &read_text_color, &read_stroke_color, 
                                &read_stroke_width, &read_font_size, 
                                &read_alignment, &read_line_spacing) == TD_SUCCESS) {
            printf("ËØªÂèñÊ∏≤ÊüìÂèÇÊï∞ÊàêÂäü:\n");
            printf("  ÊñáÂ≠óÈ¢úËâ≤: (%d,%d,%d,%d)\n", 
                  read_text_color.r, read_text_color.g, read_text_color.b, read_text_color.a);
            printf("  ÊèèËæπÈ¢úËâ≤: (%d,%d,%d,%d), ÂÆΩÂ∫¶: %d\n", 
                  read_stroke_color.r, read_stroke_color.g, read_stroke_color.b, read_stroke_color.a,
                  read_stroke_width);
            printf("  Â≠óÂè∑: %d, ÂØπÈΩê: %d, Ë°åË∑ù: %d\n", 
                  read_font_size, read_alignment, read_line_spacing);
        }
        
        bmp_free(&test_bmp);
    }



    // Ê∏ÖÁêÜËµÑÊ∫ê
    SDL_Quit();
    
    printf("\nÊâÄÊúâÊµãËØïÂÆåÊàêÔºÅÂÖ±ÁîüÊàê %d Âº†ÊµãËØïÂõæÁâá\n", 
          (36-12)/6+1 +              // ÂçïË°åÊó†ÊèèËæπ
          (36-12)/6+1 +              // ÂçïË°åÂ∏¶ÊèèËæπ
          ((36-12)/6+1)*3 +          // Â§öË°åÊó†ÊèèËæπÔºà‰∏çÂêåÂØπÈΩêÔºâ
          ((36-12)/6+1)*3 +          // Â§öË°åÂ∏¶ÊèèËæπÔºà‰∏çÂêåÂØπÈΩêÔºâ
          4 +                        // Ë°åÈó¥Ë∑ùÊµãËØï
          4 +                        // ÊèèËæπÂÆΩÂ∫¶ÊµãËØï
          3 +                        // ÈïøÊñáÊú¨ÊµãËØï
          1);                        // ÂèÇÊï∞ÊµãËØï
    
    
    return 0;
}